<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة مقارنة المكونات الذكي</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family="Inter":wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Inter font */
        html, body {
            height: 100%; /* Ensure html and body take full height */
        }
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl; /* Ensure right-to-left for Arabic */
            text-align: right; /* Align text to the right for Arabic */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex; /* Use flexbox for body */
            flex-direction: column; /* Stack children vertically */
            align-items: center; /* Center horizontally */
            padding-top: 5rem; /* Add sufficient padding at the top for buttons */
            padding-bottom: 2rem; /* Add padding at the bottom */
            padding-left: 1rem; /* Padding on sides for small screens */
            padding-right: 1rem;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        /* Adjust alignment for specific elements if needed */
        .text-center {
            text-align: center;
        }

        /* Custom scrollbar for textarea */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for selected tags */
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #d1fae5; /* Green-100 */
            color: #065f46; /* Green-800 */
            border-radius: 9999px; /* Full rounded */
            padding: 0.25rem 0.75rem; /* py-1 px-3 */
            margin: 0.25rem;
            font-size: 0.875rem; /* text-sm */
            white-space: nowrap; /* Prevent tags from wrapping */
        }
        .tag-remove {
            margin-right: 0.5rem; /* Adjusted for RTL */
            cursor: pointer;
            color: #065f46;
            font-weight: bold;
        }
        .tag-excluded {
            background-color: #fee2e2; /* Red-100 */
            color: #991b1b; /* Red-800 */
        }
        .tag-excluded .tag-remove {
            color: #991b1b;
        }

        /* Autocomplete suggestions styling */
        .autocomplete-suggestions {
            position: absolute;
            z-index: 100;
            background-color: #ffffff;
            border: 1px solid #e2e8f0; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            width: 100%; /* Ensure it spans the width of the input */
            text-align: right; /* RTL alignment */
        }
        .autocomplete-suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* gray-700 */
        }
        .autocomplete-suggestion-item:hover {
            background-color: #f0f4f8; /* gray-100 */
        }
        .autocomplete-suggestion-item.active { /* For keyboard navigation */
            background-color: #e2e8f0; /* gray-200 */
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #34d399; /* emerald-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- PWA: Link to manifest.json -->
    <link rel="manifest" href="/manifest.json">
    <!-- PWA: Add Apple touch icon for iOS -->
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    <!-- PWA: Set theme color for browser UI -->
    <meta name="theme-color" content="#4ADE80"/>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100">
    <!-- Help Button - Always visible -->
    <button id="showHelpBtn" class="absolute top-4 left-4 bg-blue-600 text-white py-2 px-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 z-50 flex items-center gap-1 text-sm">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zm-1 9a1 1 0 100-2 1 1 0 000 2zm1-5a1 1 0 10-2 0V9a1 1 0 102 0v1z" clip-rule="evenodd"></path>
        </svg>
        <span class="font-semibold">مساعدة</span>
    </button>

    <!-- Main Application Content (Always visible now) -->
    <div id="mainAppContent" class="w-full max-w-2xl mx-auto p-4 md:p-6 bg-white rounded-2xl shadow-xl border border-green-200 relative">
        <!-- Hero Section -->
        <div class="text-center mb-6 pb-4 border-b border-green-200">
            <h1 class="text-3xl font-extrabold text-emerald-800 mb-2 leading-tight">
                اكتشف سر بشرتك مع <br><span class="text-emerald-600">محلل المكونات الذكي</span>
            </h1>
            <p class="text-base text-gray-700 max-w-md mx-auto">
                أداة بسيطة لمساعدتك على فهم مكونات منتجات العناية بالبشرة. الصق القائمة ودعنا نكشف لك الحقائق!
            </p>
        </div>

        <!-- Dashboard Section -->
        <div class="mb-6 p-4 bg-indigo-50 rounded-xl shadow-sm border border-indigo-200">
            <h2 class="text-xl font-bold text-indigo-700 mb-3 text-center">لوحة التحكم</h2>
            <p class="text-sm text-gray-700 mb-2 text-center">
                <span class="font-semibold">عدد المستخدمين النشطين:</span> <span id="activeUsersCount" class="font-mono text-indigo-800 text-lg">0</span>
            </p>
            <div id="globalAnnouncement" class="p-2 bg-blue-100 border border-blue-400 text-blue-800 rounded-lg text-center mt-3 hidden text-sm">
                <p class="font-semibold">إعلان عام:</p>
                <p id="announcementText" class="italic"></p>
            </div>
            
            <!-- Admin settings are now hidden by default and shown conditionally by JS -->
            <div id="adminSettings" class="mt-4 p-3 bg-indigo-100 rounded-lg border border-indigo-300 hidden">
                <h3 class="text-lg font-bold text-indigo-700 mb-2 text-center">إعدادات المسؤول (تحديد إعلان عام)</h3>
                <p class="text-xs text-gray-700 mb-3 text-center">
                    معرف المستخدم الخاص بك: <span id="adminUserIdDisplay" class="font-mono text-indigo-800 break-all"></span>
                </p>
                <div class="mb-3">
                    <label for="globalAnnouncementInput" class="block text-gray-700 text-xs font-semibold mb-1">رسالة الإعلان العامة:</label>
                    <input type="text" id="globalAnnouncementInput" class="w-full p-2 text-sm border border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out" placeholder="اكتب إعلانًا يظهر للجميع هنا">
                </div>
                <button id="updateGlobalSettingsBtn" class="w-full bg-indigo-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300 shadow-md text-sm">
                    حفظ الإعدادات العامة
                </button>
            </div>
        </div>
        <!-- End Dashboard Section -->

        <!-- Section: Save/Load Profile -->
        <div class="mb-6 p-4 bg-purple-50 rounded-xl shadow-sm border border-purple-200">
            <h2 class="text-xl font-bold text-purple-700 mb-3 text-center">إدارة ملفاتك الشخصية</h2>
            <p class="text-xs text-gray-700 mb-2 text-center">
                <span class="font-semibold">معرف المستخدم الخاص بك:</span> <span id="userIdDisplay" class="font-mono text-purple-800 break-all">جاري الاتصال...</span>
                <br>
                <span class="font-semibold">حالة Firebase:</span> <span id="firebaseStatusDisplay" class="font-mono text-purple-800 break-all">جاري التحقق...</span>
            </p>

            <div class="mb-3">
                <label for="profileNameInput" class="block text-gray-700 text-sm font-semibold mb-1">اسم ملف البشرة (للحفظ/التحميل):</label>
                <input type="text" id="profileNameInput" class="w-full p-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 ease-in-out" placeholder="مثال: ملف بشرتي الشتوية">
            </div>

            <div class="flex flex-col sm:flex-row gap-3 justify-center mb-3">
                <button id="saveProfileBtn" class="bg-gray-400 text-white py-2 px-3 rounded-lg font-semibold cursor-not-allowed text-sm" disabled>
                    حفظ الملف الحالي (يلزم تسجيل الدخول)
                </button>
                <button id="loadNamedProfileBtn" class="bg-gray-400 text-white py-2 px-3 rounded-lg font-semibold cursor-not-allowed text-sm" disabled>
                    تحميل الملف المحدد (يلزم تسجيل الدخول)
                </button>
                <button id="deleteProfileBtn" class="bg-gray-400 text-white py-2 px-3 rounded-lg font-semibold cursor-not-allowed text-sm" disabled>
                    حذف الملف المحدد (يلزم تسجيل الدخول)
                </button>
            </div>

            <div>
                <label for="existingProfilesSelect" class="block text-gray-700 text-sm font-semibold mb-1">الملفات المحفوظة:</label>
                <select id="existingProfilesSelect" class="w-full p-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 ease-in-out" disabled>
                    <option value="">يلزم تسجيل الدخول لتحميل الملفات الشخصية</option>
                </select>
            </div>
        </div>
        <!-- End Section: Save/Load Profile -->

        <!-- Section: Scan Ingredients from Image -->
        <div class="mb-6 p-4 bg-yellow-50 rounded-xl shadow-sm border border-yellow-200">
            <h2 class="text-xl font-bold text-yellow-700 mb-3 text-center">مسح المكونات من صورة عبوة المنتج</h2>
            <p class="text-sm text-gray-700 mb-3 text-center">
                يمكنك تحميل صورة لعبوة المنتج (تأكد أن قائمة المكونات واضحة) وسنقوم بتحليلها لك تلقائياً.
            </p>
            <div class="mb-3">
                <label for="imageUpload" class="block text-gray-700 text-sm font-semibold mb-1">
                    تحميل صورة عبوة المنتج:
                </label>
                <input type="file" id="imageUpload" accept="image/*" class="w-full p-2 text-sm border border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition duration-200 ease-in-out">
            </div>
            <div id="imagePreviewContainer" class="mb-3 text-center hidden">
                <img id="imagePreview" src="#" alt="معاينة الصورة" class="max-w-full h-auto rounded-lg shadow-md mx-auto">
            </div>
            <button id="scanImageBtn" class="w-full bg-yellow-600 text-white py-2.5 px-3 rounded-lg font-semibold hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition duration-300 shadow-md hover:shadow-lg flex items-center justify-center text-sm">
                <span id="scanButtonText">مسح وتحليل المكونات من الصورة</span>
                <span id="scanLoadingSpinner" class="loader hidden"></span>
            </button>
        </div>
        <!-- End Section: Scan Ingredients from Image -->

        <!-- Section: Skin Profile -->
        <div class="mb-6 p-4 bg-fuchsia-50 rounded-xl shadow-sm border border-fuchsia-200">
            <h2 class="text-xl font-bold text-fuchsia-700 mb-3 text-center">ملفك الشخصي للبشرة</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label for="skinType" class="block text-gray-700 text-sm font-semibold mb-1">نوع بشرتك:</label>
                    <select id="skinType" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out">
                        <option value="normal">عادية</option>
                        <option value="oily">دهنية</option>
                        <option value="dry">جافة</option>
                        <option value="combination">مختلطة</option>
                        <option value="sensitive">حساسة</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-semibold mb-1">اهتمامات بشرتك:</label>
                    <div class="flex flex-wrap gap-2 text-xs">
                        <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                            <input type="checkbox" value="acne" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded skin-concern-checkbox ml-1">
                            <span>حب الشباب</span>
                        </label>
                        <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                            <input type="checkbox" value="aging" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded skin-concern-checkbox ml-1">
                            <span>الشيخوخة/التجاعيد</span>
                        </label>
                        <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                            <input type="checkbox" value="pigmentation" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded skin-concern-checkbox ml-1">
                            <span>التصبغات</span>
                        </label>
                        <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                            <input type="checkbox" value="redness" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded skin-concern-checkbox ml-1">
                            <span>الاحمرار</span>
                        </label>
                        <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                            <input type="checkbox" value="dehydration" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded skin-concern-checkbox ml-1">
                            <span>الجفاف</span>
                        </label>
                    </div>
                </div>
                <!-- New fields for age, pregnancy, and medical conditions -->
                <div>
                    <label for="userAge" class="block text-gray-700 text-sm font-semibold mb-1">عمرك:</label>
                    <input type="number" id="userAge" min="1" max="120" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out" placeholder="أدخل عمرك">
                </div>
                <div class="md:col-span-2"> <!-- Span full width for this checkbox -->
                    <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors text-xs">
                        <input type="checkbox" id="isPregnant" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded ml-1">
                        <span>هل أنت حامل؟</span>
                    </label>
                </div>
                <div class="md:col-span-2"> <!-- Span full width for this textarea -->
                    <label for="medicalConditionsInput" class="block text-gray-700 text-sm font-semibold mb-1">أمراض أو حالات صحية معينة (اختياري، مثل السكري، أمراض الكلى):</label>
                    <textarea id="medicalConditionsInput" rows="2" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out resize-y" placeholder="مثال: سكري، أمراض الكلى، حساسية الجلوتين"></textarea>
                </div>
            </div>
        </div>
        <!-- End Section: Skin Profile -->

        <!-- Section: Preferred & Excluded Ingredients -->
        <div class="mb-6 p-4 bg-sky-50 rounded-xl shadow-sm border border-sky-200">
            <h2 class="text-xl font-bold text-sky-700 mb-3 text-center">تفضيلاتك الشخصية للمكونات</h2>

            <div class="mb-4">
                <label for="preferredIngredientInput" class="block text-gray-700 text-sm font-semibold mb-1">
                    أضف مكوناتك المفضلة (مكون واحد لكل إضافة):
                </label>
                <div class="flex relative"> 
                    <input type="text" id="preferredIngredientInput" class="flex-1 p-2 text-sm border border-sky-300 rounded-l-lg rounded-r-none focus:outline-none focus:ring-2 focus:ring-sky-500 transition duration-200 ease-in-out" placeholder="مثال: Niacinamide / نياسيناميد">
                    <button id="addPreferredIngredient" class="bg-sky-600 text-white py-2 px-3 rounded-r-lg rounded-l-none font-semibold hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 transition duration-300 ease-in-out text-sm">
                        أضف
                    </button>
                    <div id="preferredSuggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div id="preferredIngredientsList" class="mt-2 flex flex-wrap gap-2 justify-end">
                    </div>
            </div>

            <div>
                <label for="excludedIngredientInput" class="block text-gray-700 text-sm font-semibold mb-1">
                    أضف مكوناتك المستبعدة/المتحسس منها:
                </label>
                <div class="flex relative"> 
                    <input type="text" id="excludedIngredientInput" class="flex-1 p-2 text-sm border border-red-300 rounded-l-lg rounded-r-none focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200 ease-in-out" placeholder="مثال: Parfum / عطور">
                    <button id="addExcludedIngredient" class="bg-red-600 text-white py-2 px-3 rounded-r-lg rounded-l-none font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-300 ease-in-out text-sm">
                        أضف
                    </button>
                    <div id="excludedSuggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div id="excludedIngredientsList" class="mt-2 flex flex-wrap gap-2 justify-end">
                    </div>
            </div>
        </div>
        <!-- End Section: Preferred & Excluding Ingredients -->

        <div class="mb-6">
            <label for="ingredientsInput" class="block text-gray-700 text-sm font-semibold mb-1">
                الصق قائمة المكونات هنا (كل مكون في سطر جديد، أو افصل بفاصلة):
            </label>
            <div class="relative"> 
                <textarea id="ingredientsInput" rows="8" class="w-full p-2 text-sm border border-emerald-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-200 ease-in-out resize-y" placeholder="مثال:
Aqua, Glycerin, Niacinamide
ماء, جليسرين, نياسيناميد
Parfum, Phthalates, Toluene"></textarea>
                <div id="mainSuggestions" class="autocomplete-suggestions hidden"></div>
            </div>
        </div>

        <button id="analyzeButton" class="w-full bg-emerald-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-300 shadow-md hover:shadow-lg text-lg">
            تحليل المكونات
        </button>

        <div id="resultsContainer" class="mt-6 p-4 bg-emerald-50 rounded-xl shadow-sm border border-emerald-200 hidden">
            <h2 class="text-xl font-bold text-emerald-700 mb-3 text-center">نتائج التحليل</h2>
            <div id="ingredientList" class="space-y-3 text-sm">
                </div>
            <div id="summary" class="mt-4 pt-3 border-t border-emerald-300 text-center text-gray-700 font-medium text-sm">
                </div>
        </div>

        <!-- Credit Section - Moved to bottom -->
        <div class="mt-6 p-3 bg-gray-50 rounded-xl shadow-sm border border-gray-200 text-center text-xs text-gray-600 italic">
            <p>هذه الأداة من تصميم وفكرة: <span class="font-semibold text-gray-800 not-italic">جورج جريج</span></p>
        </div>
        <!-- End Credit Section -->

        <!-- Message Box - Adjusted padding and text size -->
        <div id="messageBox" class="mt-4 p-2 text-sm bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg hidden" role="alert">
            </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <!-- Adjusted max-w to md for a smaller dialog -->
        <div class="bg-white p-5 rounded-xl shadow-2xl w-full max-w-md mx-4 relative">
            <button id="closeHelpBtn" class="absolute top-3 left-3 bg-red-500 text-white p-1.5 rounded-full hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-300">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-xl font-bold text-blue-700 mb-3 text-center">كيفية استخدام الأداة</h2>
            <div id="helpContent" class="text-gray-700 max-h-96 overflow-y-auto pr-2 pl-2 text-sm"> <!-- Smaller text for help content -->
                <ol class="list-decimal list-inside text-gray-700 space-y-2">
                    <li>
                        <strong class="text-blue-600">تحديد ملفك الشخصي للبشرة:</strong>
                        اختر نوع بشرتك (عادية، دهنية، جافة، مختلطة، حساسة) وحدد اهتمامات بشرتك (مثل حب الشباب، الشيخوخة، التصبغات) من خلال مربعات الاختيار.
                    </li>
                    <li>
                        <strong class="text-blue-600">إضافة تفضيلات المكونات:</strong>
                        في قسم "تفضيلاتك الشخصية للمكونات"، يمكنك:
                        <ul class="list-disc list-inside ml-5 mt-1 space-y-0.5 text-xs">
                            <li>أضف **مكوناتك المفضلة** التي تحب رؤيتها في المنتجات.</li>
                            <li>أضف **مكوناتك المستبعدة/المتحسس منها** التي ترغب في تجنبها.</li>
                            <li>ستظهر لك **اقتراحات تلقائية** أثناء الكتابة، يمكنك النقر عليها لإضافتها.</li>
                        </ul>
                    </li>
                    <li>
                        <strong class="text-blue-600">مسح المكونات من صورة:</strong>
                        في قسم "مسح المكونات من صورة عبوة المنتج"، حمّل صورة لعبوة المنتج. بعد تحميلها، انقر على زر "مسح وتحليل المكونات من الصورة" لاستخراج المكونات تلقائياً وتحليلها.
                    </li>
                    <li>
                        <strong class="text-blue-600">لصق قائمة المكونات للتحليل (بديل للمسح):</strong>
                        إذا لم ترغب في استخدام ميزة المسح، يمكنك في حقل النص الكبير، الصق قائمة المكونات من منتج العناية بالبشرة الذي ترغب في تحليله. يمكنك فصل المكونات بفاصلة (`,`) أو نقطة (`.`) أو كل مكون في سطر جديد.
                    </li>
                    <li>
                        <strong class="text-blue-600">بدء التحليل:</strong>
                        انقر على زر "<strong class="text-emerald-600">تحليل المكونات</strong>" لتبدأ الأداة في مقارنة المكونات المدخلة مع قاعدة بياناتها وتفضيلاتك الشخصية.
                    </li>
                    <li>
                        <strong class="text-blue-600">مراجعة النتائج:</strong>
                        سيظهر قسم "نتائج التحليل" مع:
                        <ul class="list-disc list-inside ml-5 mt-1 space-y-0.5 text-xs">
                            <li><strong>تصنيف كل مكون:</strong> سواء كان جيدًا، يتطلب تحذيرًا، ضارًا جداً، أو غير معروف.</li>
                            <li><strong>ملاحظات مخصصة:</strong> بناءً على نوع بشرتك واهتماماتك، بالإضافة إلى المكونات المفضلة أو المستبعدة.</li>
                            <li><strong>ملخص عام:</strong> يقدم تقييماً شاملاً لمدى ملاءمة المنتج لبشرتك.</li>
                        </ul>
                    </li>
                    <li>
                        <strong class="text-blue-600">حفظ وتحميل ملفاتك الشخصية:</strong>
                        في قسم "إدارة ملفاتك الشخصية"، ستجد هذه الميزات معطلة مؤقتًا حاليًا لأنها تتطلب تسجيل الدخول بحساب لتخزين بياناتك بشكل آمن.
                    </li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Script -->
    <!-- Place this script at the end of the body to ensure DOM elements are loaded -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, onSnapshot, query, where, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; 

        // Global variables for Firebase (MUST be defined even if empty string)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        console.log("App ID:", appId); // Log appId

        // Use __firebase_config if available, otherwise use the hardcoded one
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBiTnYz0fuR3J3Dgcc6BEpyOfF4FjF1C5I", 
            authDomain: "skin-99c39.firebaseapp.com",
            projectId: "skin-99c39",
            storageBucket: "skin-99c39.firebasestorage.app",
            messagingSenderId: "111983738514",
            appId: "1:111983738514:web:27712c903e739cebb3304b",
            measurementId: "G-GQ34RLMGS0"
        };
        console.log("Firebase Config:", firebaseConfig); // Log Firebase Config

        let app;
        let db;
        let auth;
        let currentUserId = null; 
        let isAuthReady = false; 
        let isAdmin = false; // Flag to determine if the current user is an admin

        // DOM elements for Firebase status and buttons
        let userIdDisplay;
        let firebaseStatusDisplay;
        let saveProfileBtn;
        let loadNamedProfileBtn;
        let deleteProfileBtn;
        let existingProfilesSelect;
        let adminSettings;
        let adminUserIdDisplay;
        let globalAnnouncementInput;
        let updateGlobalSettingsBtn;
        let activeUsersCount;
        let globalAnnouncement;
        let announcementText;


        // Function to show application-wide messages
        function showApplicationMessage(message, type = 'info') {
            if (window.messageBox) { // Assuming messageBox is defined in the main script and globally accessible
                window.messageBox.textContent = message;
                window.messageBox.className = `mt-4 p-2 text-sm rounded-lg ${type === 'error' ? 'bg-red-100 border-red-300 text-red-800' : 'bg-yellow-100 border-yellow-300 text-yellow-800'} block`;
                if (window.resultsContainer) window.resultsContainer.classList.add('hidden'); 
            } else {
                console.warn("Message box element not found, showing message in console:", message);
            }
        }

        // Initialize Firebase
        document.addEventListener('DOMContentLoaded', () => {
            // Get DOM elements here as they are part of the main app content
            userIdDisplay = document.getElementById('userIdDisplay');
            firebaseStatusDisplay = document.getElementById('firebaseStatusDisplay');
            saveProfileBtn = document.getElementById('saveProfileBtn');
            loadNamedProfileBtn = document.getElementById('loadNamedProfileBtn');
            deleteProfileBtn = document.getElementById('deleteProfileBtn');
            existingProfilesSelect = document.getElementById('existingProfilesSelect');
            adminSettings = document.getElementById('adminSettings'); // Admin settings div
            adminUserIdDisplay = document.getElementById('adminUserIdDisplay');
            globalAnnouncementInput = document.getElementById('globalAnnouncementInput');
            updateGlobalSettingsBtn = document.getElementById('updateGlobalSettingsBtn');
            activeUsersCount = document.getElementById('activeUsersCount');
            globalAnnouncement = document.getElementById('globalAnnouncement');
            announcementText = document.getElementById('announcementText');

            // Initially hide admin settings as per HTML, JS will show if admin
            if (adminSettings) adminSettings.classList.add('hidden'); 

            console.log("DOM Content Loaded. Initializing Firebase...");

            // Added a check to ensure firebaseConfig is not just an empty object or invalid
            if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") { 
                if (firebaseStatusDisplay) firebaseStatusDisplay.textContent = 'جاري الاتصال بـ Firebase...';
                if (userIdDisplay) userIdDisplay.textContent = 'جارٍ التحميل...';
                
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase: App and services initialized successfully.");
                    if (firebaseStatusDisplay) firebaseStatusDisplay.textContent = 'تم تهيئة Firebase بنجاح.';

                    onAuthStateChanged(auth, async (user) => {
                        try { // Added try-catch around onAuthStateChanged callback
                            console.log("onAuthStateChanged triggered. User:", user ? user.uid : "null");
                            if (user) {
                                currentUserId = user.uid;
                                isAuthReady = true;
                                console.log("Current User ID:", currentUserId); // Log the actual UID

                                // **************************************************************************************************
                                // هذا هو السطر الذي يجب تعديله بعد الحصول على معرف المستخدم الخاص بك!
                                //
                                // استبدل 'YOUR_ADMIN_UID_HERE' بمعرف المستخدم (UID) الخاص بك الذي يظهر في الواجهة.
                                // على سبيل المثال: 'yourActualFirebaseUIDString'
                                const TEST_ADMIN_UID = 'ehhahtecgOh2PB7p8dnI5RwYh1u2'; 
                                // **************************************************************************************************

                                isAdmin = (currentUserId === TEST_ADMIN_UID);
                                console.log("Is Admin:", isAdmin); // Log if user is identified as admin

                                console.log("Firebase User active. User ID:", currentUserId);
                                if (userIdDisplay) userIdDisplay.textContent = currentUserId + (isAdmin ? " (مسؤول)" : " (مجهول)"); 
                                if (firebaseStatusDisplay) firebaseStatusDisplay.textContent = 'Firebase جاهز (متصل).';

                                // Show/hide admin settings based on isAdmin flag
                                if (adminSettings) {
                                    if (isAdmin) {
                                        adminSettings.classList.remove('hidden');
                                        if (adminUserIdDisplay) adminUserIdDisplay.textContent = currentUserId + " (أنت المسؤول)";
                                        if (updateGlobalSettingsBtn) updateGlobalSettingsBtn.disabled = false; // Enable admin button
                                    } else {
                                        adminSettings.classList.add('hidden');
                                        if (adminUserIdDisplay) adminUserIdDisplay.textContent = currentUserId + " (ليس مسؤول)"; // Show current ID for non-admin
                                        if (updateGlobalSettingsBtn) updateGlobalSettingsBtn.disabled = true; // Disable for non-admin
                                    }
                                }
                                
                                // Public dashboard features will work with anonymous auth
                                updatePresence();
                                setInterval(updatePresence, 30000);
                                listenForActiveUsers();
                                listenForGlobalConfig();

                            } else {
                                console.log("No user found, attempting anonymous sign-in...");
                                // If no user, sign in anonymously to allow access to public rules
                                try {
                                    await signInAnonymously(auth);
                                    console.log("Signed in anonymously successfully.");
                                    // onAuthStateChanged will trigger again with the anonymous user
                                } catch (anonError) {
                                    console.error("Failed to sign in anonymously:", anonError);
                                    if (firebaseStatusDisplay) firebaseStatusDisplay.textContent = 'فشل الاتصال بـ Firebase (خطأ مجهول).';
                                    showApplicationMessage("فشل الاتصال بخدمات Firebase. بعض الميزات قد لا تعمل.", 'error');
                                }
                            }
                        } catch (authError) {
                            console.error("Error inside onAuthStateChanged callback:", authError);
                            if (firebaseStatusDisplay) firebaseStatusDisplay.textContent = 'خطأ في معالجة حالة المصادقة.';
                            showApplicationMessage("حدث خطأ في المصادقة. يرجى التحقق من وحدة تحكم المتصفح.", 'error');
                        }
                    });

                } catch (initError) {
                    console.error("Firebase initialization failed during try-catch:", initError);
                    if (firebaseStatusDisplay) firebaseStatusDisplay.textContent = 'فشل تهيئة Firebase.';
                    showApplicationMessage("فشل تهيئة Firebase. ميزة حفظ/تحميل ملفك الشخصي غير متوفرة. يرجى مراجعة وحدة تحكم المتصفح للمزيد من التفاصيل.", 'error'); 
                    // Disable save/load buttons visually and functionally
                    if (saveProfileBtn) saveProfileBtn.disabled = true;
                    if (loadNamedProfileBtn) loadNamedProfileBtn.disabled = true;
                    if (deleteProfileBtn) deleteProfileBtn.disabled = true;
                    if (existingProfilesSelect) existingProfilesSelect.disabled = true;
                }
            } else {
                console.warn("Firebase config not found or incomplete. Save/Load profile functionality and Dashboard features will not be available.");
                if (userIdDisplay) userIdDisplay.textContent = 'غير متوفر (لم يتم تهيئة Firebase)';
                if (firebaseStatusDisplay) firebaseStatusDisplay.textContent = 'تكوين Firebase غير موجود أو غير مكتمل.';
                showApplicationMessage("لم يتم توفير تكوين Firebase أو أنه غير مكتمل. ميزة حفظ/تحميل ملفك الشخصي ولوحة التحكم غير متوفرة.", 'error');
                // Disable save/load buttons visually and functionally
                if (saveProfileBtn) saveProfileBtn.disabled = true;
                if (loadNamedProfileBtn) loadNamedProfileBtn.disabled = true;
                if (deleteProfileBtn) deleteProfileBtn.disabled = true;
                if (existingProfilesSelect) existingProfilesSelect.disabled = true;
                if (adminSettings) adminSettings.classList.add('hidden');
            }
        }); 

        // --- Firestore Utility Functions (Presence and Global Config) ---

        async function updatePresence() {
            // Check if auth is ready and user is not null (anonymous or registered)
            if (!isAuthReady || !currentUserId || !db) { 
                console.warn("Update presence skipped: Firebase not ready or user not active.");
                return;
            }
            try {
                const presenceDocRef = doc(db, `artifacts/${appId}/public/presence/${currentUserId}`);
                await setDoc(presenceDocRef, {
                    lastActive: serverTimestamp(), 
                }, { merge: true }); 
                console.log("Presence updated for:", currentUserId); // Log presence update
            } catch (error) {
                console.error("Error updating presence for", currentUserId, ":", error);
            }
        }

        function listenForActiveUsers() {
            if (!isAuthReady || !currentUserId || !db) { 
                console.warn("Skipping active users listener: Firebase not ready or user not active.");
                return;
            }
            const presenceCollectionRef = collection(db, `artifacts/${appId}/public/presence`);
            
            onSnapshot(presenceCollectionRef, (snapshot) => {
                let activeUsers = 0;
                const now = Date.now();
                const sixtySecondsAgo = now - (60 * 1000); // Consider active if updated in last 60 seconds (extended from 30s)

                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.lastActive && data.lastActive.toMillis() > sixtySecondsAgo) {
                        activeUsers++;
                    }
                });
                if (activeUsersCount) {
                    activeUsersCount.textContent = activeUsers;
                }
                console.log("Active users updated:", activeUsers); // Log active users count
            }, (error) => {
                console.error("Error listening for active users:", error);
                showApplicationMessage("فشل تحديث عدد المستخدمين النشطين.", 'error');
            });
        }

        function listenForGlobalConfig() {
            if (!isAuthReady || !currentUserId || !db) { 
                console.warn("Skipping global config listener: Firebase not ready or user not active.");
                return;
            }
            const configDocRef = doc(db, `artifacts/${appId}/public/config/appConfig`);
            
            onSnapshot(configDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const configData = docSnap.data();
                    const announcement = configData.globalAnnouncement || '';
                    if (announcementText) {
                        announcementText.textContent = announcement;
                        if (announcement) {
                            globalAnnouncement.classList.remove('hidden');
                        } else {
                            globalAnnouncement.classList.add('hidden');
                        }
                    }
                    if (globalAnnouncementInput) { 
                        globalAnnouncementInput.value = announcement;
                    }
                    console.log("Global announcement updated:", announcement); // Log announcement update
                } else {
                    if (announcementText) {
                        announcementText.textContent = '';
                        globalAnnouncement.classList.add('hidden');
                    }
                    console.log("No global announcement found."); // Log no announcement
                }
            }, (error) => {
                console.error("Error listening for global config:", error);
                showApplicationMessage("فشل تحديث الإعدادات العامة.", 'error');
            });
        }

        // Modified saveGlobalConfig to allow updates for admin
        window.saveGlobalConfig = async function() {
            if (!isAuthReady || !currentUserId || !db) {
                showApplicationMessage("لا يمكن حفظ الإعدادات العامة. يرجى التأكد من اتصال Firebase.", 'error');
                return;
            }
            if (!isAdmin) { // Only allow admin to save
                showApplicationMessage("ليس لديك صلاحيات لحفظ الإعدادات العامة. هذا القسم للمسؤولين فقط.", 'error');
                return;
            }

            const announcement = globalAnnouncementInput.value.trim();
            const configDocRef = doc(db, `artifacts/${appId}/public/config/appConfig`);

            try {
                await setDoc(configDocRef, {
                    globalAnnouncement: announcement,
                    lastUpdated: serverTimestamp()
                }, { merge: true });
                showApplicationMessage("تم حفظ الإعدادات العامة بنجاح!", 'info');
                console.log("Global config saved by admin:", currentUserId);
            } catch (error) {
                console.error("Error saving global config:", error);
                showApplicationMessage(`فشل حفظ الإعدادات العامة: ${error.message}. تأكد من تحديث قواعد أمان Firebase Firestore للسماح للمسؤول بالكتابة.`, 'error');
            }
        };

        // --- End Firestore Utility Functions ---


        // Functions to save and load profile from Firestore (still disabled without proper login)
        window.saveProfile = async function(profileName) {
            showApplicationMessage("لحفظ ملفك الشخصي، يجب أن تكون مسجلاً بحساب. ميزة حفظ الملفات الشخصية معطلة حالياً.", 'error');
        };

        window.loadProfile = async function(profileName, silent = false) {
            if (!silent) showApplicationMessage("لتحميل ملفاتك الشخصية، يجب أن تكون مسجلاً بحساب. ميزة تحميل الملفات الشخصية معطلة حالياً.", 'error');
        };

        window.deleteProfile = async function(profileName) {
            showApplicationMessage("لحذف ملفك الشخصي، يجب أن تكون مسجلاً بحساب. ميزة حذف الملفات الشخصية معطلة حالياً.", 'error');
        };

        async function populateProfileDropdown() {
            if (existingProfilesSelect) {
                 existingProfilesSelect.innerHTML = '<option value="">يلزم تسجيل الدخول لحفظ الملفات الشخصية</option>'; 
            }
            // All profile management requires a registered user
            showApplicationMessage("ميزة إدارة الملفات الشخصية تتطلب تسجيل الدخول بحساب لتخزين بياناتك بأمان.", 'info');
        }
    </script>

    <!-- Main application logic Script -->
    <script>
        // Global variables for DOM elements and data
        let skinTypeSelect;
        let skinConcernCheckboxes;
        let userAgeInput; 
        let isPregnantCheckbox; 
        let medicalConditionsInput; 
        let preferredIngredientInput;
        let addPreferredIngredient;
        let preferredIngredientsList;
        let excludedIngredientInput;
        let addExcludedIngredient;
        let excludedIngredientsList;
        let ingredientsInput;
        let analyzeButton;
        let resultsContainer;
        let ingredientList;
        let summary;
        let messageBox;
        let profileNameInput;
        let existingProfilesSelect;
        let firebaseStatusDisplay;
        let imageUpload;
        let imagePreview;
        let imagePreviewContainer;
        let scanImageBtn;
        let scanButtonText;
        let scanLoadingSpinner;
        let deleteProfileBtn; 

        // Autocomplete suggestion divs
        let preferredSuggestions;
        let excludedSuggestions;
        let mainSuggestions;

        // Dashboard elements (now managed directly in module script)
        let activeUsersCount;
        let adminSettings;
        let adminUserIdDisplay;
        let globalAnnouncementInput;
        let updateGlobalSettingsBtn;
        let globalAnnouncement;
        let announcementText;


        // User preference arrays (Accessible globally by other scripts via window.userPreferredIngredients)
        window.userPreferredIngredients = [];
        window.userExcludedIngredients = [];

        // Define the hardcoded ingredients database (Accessible globally by other scripts)
        window.ingredientsDatabase = [
            // Basic Ingredients
            { name: ['Aqua', 'ماء'], classification: 'جيد للبشرة', description: 'الماء هو المذيب الأساسي في العديد من مستحضرات التجميل.' },
            { name: ['Glycerin', 'جليسرين', 'الجليسرين'], classification: 'جيد للبشرة', description: 'مرطب ممتاز يجذب الرطوبة إلى البشرة ويمنع فقدان الماء.', skin_notes: { dry: 'ممتاز للبشرة الجافة والمجففة.', dehydration: 'يساعد بشكل كبير في ترطيب البشرة المجففة.' } },
            { name: ['Niacinamide', 'نياسيناميد'], classification: 'جيد للبشرة', description: 'فيتامين B3، يحسن وظيفة حاجز البشرة ويقلل الالتهاب.', skin_notes: { acne: 'يساعد في تقليل حب الشباب والتحكم في الإفرازات الدهنية.', redness: 'يقلل الاحمرار والالتهاب.', aging: 'يحسن مظهر الخطوط الدقيقة والتصبغات.' } },
            { name: ['Sodium Hyaluronate', 'هيالورونات الصوديوم', 'حمض الهيالورونيك'], classification: 'جيد للبشرة', description: 'شكل من حمض الهيالورونيك، مرطب قوي للبشرة.', skin_notes: { dry: 'مرطب فعال للغاية للبشرة الجافة.', dehydration: 'يعزز ترطيب البشرة ويجعلها أكثر امتلاءً.' } } ,
            { name: ['Tocopherol', 'فيتامين E', 'توكوفيرول'], classification: 'جيد للبشرة', description: 'فيتامين E، مضاد للأكسدة يحمي البشرة.', skin_notes: { aging: 'يساعد في حماية البشرة من أضرار الجذور الحرة التي تساهم في الشيخوخة.' } },
            { name: ['Aloe Barbadensis Leaf Juice', 'عصير أوراق الألوفيرا', 'صبار'], classification: 'عضوي', description: 'عصير أوراق الألوفيرا، مهدئ ومرطب للبشرة.', skin_notes: { sensitive: 'مهدئ ممتاز للبشرة الحساسة والمتهيجة.', redness: 'يساعد في تخفيف الاحمرار.' } },
            { name: ['Simmondsia Chinensis Seed Oil', 'زيت الجوجوبا'], classification: 'عضوي', description: 'زيت الجوجوبا، يرطب البشرة دون انسداد المسام.', skin_notes: { oily: 'يشبه الزيوت الطبيعية للبشرة، مما يساعد على توازن إفراز الدهون.', acne: 'غير كوميدوغينيك، لا يسد المسام.' } },
            { name: ['Butyrospermum Parkii Butter', 'زبدة الشيا', 'شيا'], classification: 'جيد للبشرة', description: 'زبدة الشيا، مرطب غني ومغذي للبشرة.', skin_notes: { dry: 'مرطب مكثف للبشرة الجافة جدًا والمتشققة.' } },
            { name: ['Lactic Acid', 'حمض اللاكتيك'], classification: 'تحذير: مهيج محتمل', description: 'حمض ألفا هيدروكسي (AHA) مقشر، قد يسبب تهيجًا بتركيزات عالية.', skin_notes: { sensitive: 'قد يسبب تهيجًا للبشرة الحساسة، ابدأ بتركيزات منخفضة.', dry: 'مقشر لطيف، مفيد للبشرة الجافة في تركيزات منخفضة.' } },
            { name: ['Phenoxyethanol', 'فنوكسييثانول'], classification: 'جيد للبشرة', description: 'مادة حافظة آمنة بشكل عام بتركيزات منخفضة.' },
            { name: ['Titanium Dioxide', 'ثاني أكسيد التيتانيوم'], classification: 'جيد للبشرة', description: 'مكون واقي شمسي فيزيائي، وصبغة تضفي اللون.' },
            { name: ['Zinc Oxide', 'أكسيد الزنك'], classification: 'جيد للبشرة', description: 'مكون واقي شمسي فيزيائي.', skin_notes: { acne: 'يساعد في تهدئة الالتهاب وتقليل حب الشباب.' } },
            { name: ['Argania Spinosa Kernel Oil', 'زيت الأرغان', 'أرغان'], classification: 'عضوي', description: 'زيت الأرغان، غني بمضادات الأكسدة وفيتامين E، مرطب ومغذي للبشرة.', skin_notes: { dry: 'مرطب ممتاز للبشرة الجافة.', aging: 'يساعد في تحسين مرونة البشرة.' } },
            { name: ['Mica', 'ميكا'], classification: 'جيد للبشرة', description: 'مادة طبيعية توفر لمعانًا وتألقًا للمنتجات.' },
            { name: ['Silica', 'سيليكا'], classification: 'جيد للبشرة', description: 'مادة توفر تركيبة ناعمة وامتصاص الزيوت الزائدة.', skin_notes: { oily: 'يساعد في امتصاص الزيوت الزائدة وتقليل اللمعان.' } },
            { name: ['Talc', 'تلك'], classification: 'جيد للبشرة', description: 'مادة توفر نعومة وسهولة في التطبيق، وتساعد على امتصاص الزيوت.' },
            { name: ['Iron Oxides', 'أكاسيد الحديد'], classification: 'جيد للبشرة', description: 'أصباغ معدنية تستخدم لإضفاء اللون على المنتجات.' },
            { name: ['Liposomes', 'جسيمات شحمية'], classification: 'جيد للبشرة', description: 'كبسولات صغيرة تساعد على توصيل وامتصاص المكونات النشطة في البشرة.' },
            { name: ['Dimethicone', 'Silicon', 'سيليكون', 'دايميثيكون'], classification: 'تحذير: قد يسبب انسداد المسام', description: 'مادة شائعة في مستحضرات التجميل تمنح ملمسًا ناعمًا وتعمل كحاجز، ولكن بعض أنواعها قد تسد المسام وتمنع البشرة من التنفس.', skin_notes: { oily: 'قد يسد المسام ويزيد من ظهور حب الشباب للبشرة الدهنية.', acne: 'يمكن أن يفاقم حب الشباب عن طريق حبس الزيوت والبكتيريا.', sensitive: 'آمن بشكل عام للبشرة الحساسة ما لم يسبب تهيجًا من انسداد المسام.' } },
            // New Ingredients Added previously
            { name: ['Cyclopentasiloxane', 'سيكلوبنتاسيلوكسان'], classification: 'جيد للبشرة', description: 'سيليكون خفيف ومتطاير يمنح ملمسًا ناعمًا وغير دهني، ويساعد على انتشار المنتجات بسهولة.', skin_notes: { oily: 'لا يسد المسام عادةً، ويمنح شعورًا غير دهني للبشرة الدهنية.', acne: 'غير كوميدوغينيك بشكل عام، لا يساهم في حب الشباب.', sensitive: 'يستخدم لتقليل الملمس الدهني وتهدئة البشرة دون تهيج.' } },
            { name: ['Squalane', 'سكوالان'], classification: 'جيد للبشرة', description: 'مكون مرطب ومطري ممتاز يشبه الزيوت الطبيعية للبشرة، ويساعد على ترميم حاجز البشرة.', skin_notes: { dry: 'مرطب فعال للغاية للبشرة الجافة والمجففة.', oily: 'خفيف ولا يسد المسام، مناسب للبشرة الدهنية.', sensitive: 'لطيف جداً ومهدئ للبشرة الحساسة.', aging: 'يساعد في تحسين مرونة البشرة وتقليل ظهور الخطوط الدقيقة.' } },
            { name: ['Caprylic/Capric Triglyceride', 'كابريليك/كابريك ثلاثي الجليسريد'], classification: 'جيد للبشرة', description: 'مادة مطرية مشتقة من زيت جوز الهند والجلسرين، توفر ترطيبًا خفيفًا وملمسًا ناعمًا.', skin_notes: { normal: 'مناسب لمعظم أنواع البشرة.', oily: 'خفيف ولا يسد المسام للبشرة الدهنية.', dry: 'يوفر ترطيبًا خفيفًا دون إثقال البشرة.', sensitive: 'لطيف جداً ونادراً ما يسبب تهيجاً.' } },
            { name: ['Urea', 'يوريا'], classification: 'جيد للبشرة', description: 'مرطب قوي ومقشر لطيف بتركيزات منخفضة، يساعد على إزالة خلايا الجلد الميتة وتحسين امتصاص المكونات.', skin_notes: { dry: 'ممتاز للبشرة الجافة جداً والخشنة، يساعد على تليينها.', dehydration: 'يعزز قدرة البشرة على الاحتفاظ بالماء.', sensitive: 'قد يسبب تهيجاً بتركيزات عالية، ابدأ بتركيزات منخفضة.' } },
            { name: ['Sodium Benzoate', 'بنزوات الصوديوم'], classification: 'جيد للبشرة', description: 'مادة حافظة شائعة تستخدم لمنع نمو البكتيريا والفطريات في المنتجات.' },
            { name: ['Octinoxate', 'أوكتينوكسات'], classification: 'تحذير: مكون مثير للجدل', description: 'مرشح كيميائي للأشعة فوق البنفسجية (UVB)، قد يثير مخاوف بيئية وصحية.', skin_notes: { sensitive: 'قد يسبب تهيجًا أو ردود فعل تحسسية للبشرة الحساسة.' } },
            { name: ['Avobenzone', 'أفوبنزون'], classification: 'تحذير: مكون مثير للجدل', description: 'مرشح كيميائي للأشعة فوق البنفسجية (UVA)، قد يكون غير مستقر ويتطلب مثبتات.', skin_notes: { sensitive: 'قد يسبب تهيجًا أو ردود فعل تحسسية للبشرة الحساسة.' } },
            { name: ['Ethanol', 'إيثانول'], classification: 'تحذير: مهيج محتمل', description: 'كحول يستخدم كمذيب وعامل مطهر في العديد من المنتجات، قد يسبب جفافًا وتهيجًا.', skin_notes: { dry: 'يجرد البشرة من زيوتها الطبيعية ويزيد من الجفاف.', oily: 'قد يؤدي إلى زيادة إفراز الزيوت على المدى الطويل.', sensitive: 'مهيج قوي جداً للبشرة الحساسة.' } },
            { name: ['Synthetic Musk', 'مسك صناعي'], classification: 'تحذير: مكون مثير للجدل', description: 'مركبات عطرية صناعية تحاكي رائحة المسك الطبيعي، تثير مخاوف بيئية وصحية محتملة.', skin_notes: { sensitive: 'قد تسبب تهيجًا أو حساسية للبشرة الحساسة.' } },
            { name: ['Benzyl Alcohol', 'كحول بنزيلي'], classification: 'تحذير: مهيج محتمل', description: 'كحول عطري يستخدم كمادة حافظة ومذيب ومكون عطري، قد يسبب تهيجًا.', skin_notes: { sensitive: 'يعد من مسببات الحساسية الشائعة للبشرة الحساسة.' } },
            { name: ['Linalool', 'لينالول'], classification: 'تحذير: مهيج محتمل', description: 'مكون عطري طبيعي موجود في العديد من الزيوت الأساسية، ولكنه قد يكون مسبباً للحساسية.', skin_notes: { sensitive: 'مسبب شائع للحساسية والتهيج للبشرة الحساسة.' } },
            { name: ['Geraniol', 'جيرانيول'], classification: 'تحذير: مهيج محتمل', description: 'مكون عطري طبيعي موجود في العديد من الزيوت الأساسية، قد يكون مسبباً للحساسية.', skin_notes: { sensitive: 'مسبب شائع للحساسية والتهيج للبشرة الحساسة.' } },
            // New Ingredients Added in "اليوم الأول"
            { name: ['Salicylic Acid', 'حمض الساليسيليك'], classification: 'جيد للبشرة', description: 'حمض بيتا هيدروكسي (BHA) يعمل كمقشر داخل المسام، فعال في علاج حب الشباب والرؤوس السوداء.', skin_notes: { acne: 'ممتاز لتقليل البثور والرؤوس السوداء والبيضاء.', oily: 'يساعد على التحكم في إفراز الزيوت وتنقيع المسام.', sensitive: 'قد يسبب جفافاً أو تهيجاً في البداية، ابدأ بتركيزات منخفضة.' }, pregnancy_notes: 'قد يسبب مشاكل في التركيزات العالية أثناء الحمل، يفضل استشارة الطبيب.' }, 
            { name: ['Squalene', 'سكوالين'], classification: 'جيد للبشرة', description: 'دهن طبيعي موجود في زيوت البشرة، يُستخدم كمرطب ومطري ممتاز، مشتق عادةً من الزيتون أو قصب السكر. (يختلف عن السكوالان Squalane الذي هو شكل مستقر منه).', skin_notes: { dry: 'يرطب البشرة بعمق ويعزز حاجزها الطبيعي.', sensitive: 'لطيف للغاية ونادراً ما يسبب تهيجاً.', normal: 'يشبه الزيوت الطبيعية للبشرة، مما يجعله متوافقاً مع معظم الأنواع.' } },
            { name: ['Amber', 'عنبر'], classification: 'مكون عطري', description: 'في العطور، "العنبر" عادة ما يشير إلى اتفاق عطري دافئ وغني وحلو يذكرنا بالراتنجات، وغالباً ما يكون صناعياً. (لا يجب الخلط بينه وبين "العنبرية" أو "قيء الحوت" Ambergris وهو مكون حيواني مختلف).', skin_notes: { sensitive: 'قد تسبب المكونات العطرية بشكل عام تهيجاً للبشرة الحساسة.' } },
            // New Ingredients Added in "اليوم الثاني"
            { name: ['Ascorbic Acid', 'حمض الأسكوربيك'], classification: 'جيد للبشرة', description: 'هو الشكل النقي لفيتامين C، وهو مضاد أكسدة قوي يساعد على تفتيح البشرة، تقليل التصبغات، وتعزيز إنتاج الكولاجين. قد يكون غير مستقر ويتأكسد بسهولة.', skin_notes: { pigmentation: 'فعال جداً في تفتيح البقع الداكنة وتوحيد لون البشرة.', aging: 'يحفز إنتاج الكولاجين لتحسين مرونة البشرة وتقليل الخطوط الدقيقة.', sensitive: 'قد يسبب وخزاً خفيفاً أو تهيجاً في البداية لبعض أنواع البشرة الحساسة، خصوصاً في التركيزات العالية.' } },
            { name: ['Polysorbate 20', 'بولي سوربات 20'], classification: 'جيد للبشرة', description: 'مستحلب ومذيب غير أيوني يُستخدم للمساعدة في خلط الزيوت والعطور مع الماء في المستحضرات، كما يعمل كعامل ترطيب خفيف.', skin_notes: { normal: 'يعتبر آمناً بشكل عام وغير مهيج لمعظم أنواع البشرة في التركيزات المستخدمة في مستحضرات التجميل.' } },
            { name: ['BHT', 'Butylated Hydroxytoluene', 'بي إتش تي'], classification: 'تحذير: مكون مثير للجدل', description: 'مضاد أكسدة صناعي يُستخدم لمنع تزنخ الزيوت والمكونات الأخرى، ويُضاف كمادة حافظة في العديد من المنتجات. أثيرت حوله بعض المخاوف الصحية والبيئية.', skin_notes: { sensitive: 'قد يسبب تفاعلات تحسسية لدى بعض الأشخاص، ولكن هذا نادر الحدوث.' } },

            // New Ingredients Added (from previous update)
            { name: ['Ceramides', 'سيراميدات', 'السيراميدات'], classification: 'جيد للبشرة', description: 'دهون طبيعية ضرورية تشكل حاجز البشرة، تساعد في الحفاظ على ترطيبها وحمايتها.', skin_notes: { dry: 'ضرورية لترميم حاجز البشرة الجافة ومنع فقدان الماء.', sensitive: 'تهدئ البشرة الحساسة وتقوي حاجزها الواقي.' } },
            { name: ['Peptides', 'ببتيدات', 'الببتيدات'], classification: 'جيد للبشرة', description: 'سلاسل قصيرة من الأحماض الأمينية التي يمكن أن تحفز إنتاج الكولاجين والإيلاستين لتحسين مرونة البشرة.', skin_notes: { aging: 'تساعد في تقليل ظهور الخطوط الدقيقة والتجاعيد وتعزز تماسك البشرة.' } },
            { name: ['Hyaluronic Acid', 'حمض الهيالورونيك'], classification: 'جيد للبشرة', description: 'مرطب قوي يجذب الرطوبة ويحتفظ بها في البشرة، مما يجعلها تبدو أكثر امتلاءً ونضارة.', skin_notes: { dry: 'يرطب البشرة بعمق ويحسن مرونتها.', dehydration: 'يعد أحد أفضل المكونات لمكافحة جفاف البشرة.' } },
            { name: ['Retinol', 'ريتينول', 'الريتينول'], classification: 'جيد للبشرة', description: 'شكل من فيتامين A، يعزز تجديد الخلايا ويقلل من علامات الشيخوخة وحب الشباب. قد يسبب تهيجاً في البداية.', skin_notes: { aging: 'يقلل التجاعيد ويحسن ملمس البشرة.', acne: 'فعال في علاج حب الشباب بتقليل انسداد المسام.', sensitive: 'قد يسبب احمراراً أو تقشيراً في البداية، ابدأ بتركيزات منخفضة.' }, pregnancy_notes: 'يجب تجنبه تماماً أثناء الحمل والرضاعة.' }, 
            { name: ['Glycolic Acid', 'حمض الجليكوليك'], classification: 'تحذير: مهيج محتمل', description: 'حمض ألفا هيدروكسي (AHA) يعمل كمقشر كيميائي لإزالة الخلايا الميتة من سطح البشرة وتحسين الإشراق.', skin_notes: { pigmentation: 'يساعد في تقليل التصبغات والبقع الداكنة.', sensitive: 'قد يسبب تهيجاً واحمراراً للبشرة الحساسة، ابدأ بتركيزات منخفضة.' }, pregnancy_notes: 'قد يسبب مشاكل في التركيزات العالية أثناء الحمل، يفضل استشارة الطبيب.' }, 
            { name: ['Tea Tree Oil', 'زيت شجرة الشاي'], classification: 'عضوي', description: 'زيت طبيعي له خصائص مضادة للبكتيريا والالتهابات، يستخدم في علاج حب الشباب.', skin_notes: { acne: 'فعال في تقليل حب الشباب وتقليل الالتهاب.', sensitive: 'قد يكون قوياً ومهيجاً للبشرة الحساسة، يجب تخفيفه قبل الاستخدام.' }, medical_notes: [{keyword: 'سكري', text: 'قد يؤثر على مستويات السكر في الدم عند تناوله عن طريق الفم، لكن الاستخدام الموضعي آمن بشكل عام.'}] }, 
            { name: ['Colloidal Oatmeal', 'دقيق الشوفان الغروي'], classification: 'جيد للبشرة', description: 'مكون طبيعي مهدئ ومضاد للالتهابات، يساعد على تخفيف الحكة والاحمرار والجفاف.', skin_notes: { sensitive: 'ممتاز للبشرة الحساسة والمتهيجة والمعرضة للإكزيما.', dry: 'يساعد على تهدئة البشرة الجافة جداً والمتهيجة وترطيبها.' } },
            // Newly Added Ingredients (current update)
            { name: ['Bakuchiol', 'باكوتشيول'], classification: 'جيد للبشرة', description: 'مركب طبيعي مستخلص من نبات الباكوتشي، يعتبر بديلاً طبيعياً للريتينول بخصائص مضادة للشيخوخة دون تهيج كبير.', skin_notes: { aging: 'يساعد في تقليل ظهور الخطوط الدقيقة والتجاعيد.', sensitive: 'لطيف بشكل عام على البشرة الحساسة مقارنة بالريتينول.' } },
            { name: ['Azelaic Acid', 'حمض الأزيليك'], classification: 'جيد للبشرة', description: 'حمض ثنائي الكربوكسيل يساعد في علاج حب الشباب والوردية عن طريق تقليل الالتهاب وقتل البكتيريا.', skin_notes: { acne: 'فعال في علاج حب الشباب وتقليل الاحمرار والالتهاب.', redness: 'يقلل الاحمرار المصاحب للوردية وحب الشباب.' } },
            { name: ['Centella Asiatica', 'سنتيلا اسياتيكا', 'سيكا', 'Cica'], classification: 'جيد للبشرة', description: 'مستخلص عشبي معروف بخصائصه المهدئة والمضادة للالتهابات والمساعدة في التئام الجروح.', skin_notes: { sensitive: 'ممتاز لتهدئة البشرة المتهيجة والحساسة.', redness: 'يساعد في تقليل الاحمرار والتهدئة بعد التهيج.' } },
            { name: ['Snail Mucin', 'مخاط الحلزون'], classification: 'جيد للبشرة', description: 'مكون مرطب ومجدد للبشرة، يساعد في الترطيب وتحسين نسيج البشرة وإصلاحها.', skin_notes: { dry: 'يرطب البشرة بعمق ويحسن مرونتها.', aging: 'يساعد في تجديد الخلايا وتقليل الخطوط الدقيقة.' } },
            { name: ['Denatured Alcohol', 'كحول دناتوري'], classification: 'تحذير: مهيج محتمل', description: 'نوع من الكحول يستخدم كمذيب وعامل مطهر، ولكنه قد يكون مجففاً ومهيجاً للبشرة على المدى الطويل.', skin_notes: { dry: 'يسبب جفافاً شديداً للبشرة ويضر حاجزها.', oily: 'قد يؤدي إلى زيادة إفراز الزيوت كرد فعل على الجفاف.', sensitive: 'مهيج جداً للبشرة الحساسة.' } },
            { name: ['Propylene Glycol', 'بروبيلين جلايكول'], classification: 'جيد للبشرة', description: 'مرطب ومذيب يساعد على جذب الرطوبة إلى البشرة ويحسن امتصاص المكونات الأخرى.', skin_notes: { normal: 'مرطب جيد لمعظم أنواع البشرة.', sensitive: 'نادراً ما يسبب تهيجاً، لكن قد يعاني البعض من حساسية خفيفة.' } },
            { name: ['Essential Oils', 'زيوت أساسية'], classification: 'تحذير: مهيج محتمل', description: 'زيوت عطرية مركزة مستخلصة من النباتات، تستخدم للرائحة أو الفوائد العلاجية، ولكنها قد تسبب تهيجاً أو حساسية للبشرة الحساسة.', skin_notes: { sensitive: 'مسببات شائعة للحساسية والتهيج.', redness: 'قد تزيد من الاحمرار والالتهاب.' } },


            // Harmful/Controversial Ingredients
            { name: ['Parfum', 'عطر', 'عطور', 'Fragrance'], classification: 'تحذير: مهيج محتمل', description: 'العطور قد تسبب تهيجًا للبشرة الحساسة أو ردود فعل تحسسية.', skin_notes: { sensitive: 'سبب شائع للحساسية والتهيج.', redness: 'قد يزيد من الاحمرار والالتهاب.' } },
            { name: ['Sodium Lauryl Sulfate', 'كبريتات لوريل الصوديوم', 'SLS'], classification: 'تحذير: مهيج محتمل', description: 'منظف قوي، قد يسبب جفافًا وتهيجًا للبشرة.', skin_notes: { dry: 'يجرد البشرة من زيوتها الطبيعية مما يزيد الجفاف.', sensitive: 'مهيج قوي للبشرة الحساسة.' } },
            { name: ['Phthalates', 'فثالات', 'فثالات ديبوتيل', 'Dibutyl Phthalate', 'DBP'], classification: 'تحذير: مكون ضار جداً', description: 'مركبات كيميائية قد تسبب اضطرابات هرمونية وتثير القلق بشأن الصحة الإنجابية.' },
            { name: ['Toluene', 'تولوين'], classification: 'تحذير: مهيج محتمل', description: 'مذيب كيميائي قد يسبب تهيجًا للجلد والجهاز التنفسي، ويستخدم في بعض مستحضرات التجميل.' },
            { name: ['Polyethylene', 'بولي إيثيلين'], classification: 'تحذير: قد يسبب انسداد المسام', description: 'بوليمر بلاستيكي يستخدم كعامل تشكيل للفيلم أو كمقشر دقيق، قد يسبب انسداد المسام.', skin_notes: { oily: 'قد يسد المسام ويزيد من حب الشباب.', acne: 'يزيد من خطر انسداد المسام وتفاقم حب الشباب.' } },
            { name: ['Carbon black', 'أسود الكربون'], classification: 'تحذير: مكون مثير للجدل', description: 'صبغة سوداء تستخدم في مستحضرات التجميل، قد تحتوي على شوائب مثيرة للجدل ومسرطنة.' },
            { name: ['Parabens', 'بارابين'], classification: 'تحذير: مكون ضار جداً', description: 'مواد حافظة شائعة، قد تسبب اضطرابات هرمونية وتثير القلق بشأن السرطان.' },
            { name: ['Formaldehyde', 'فورمالديهايد'], classification: 'تحذير: مكون ضار جداً', description: 'مادة حافظة ومطهرة، مصنفة كمسرطن معروف للإنسان ومسببة للحساسية.' },
            { name: ['Mineral Oil', 'زيت معدني'], classification: 'تحذير: قد يسبب انسداد المسام', description: 'منتج بترولي، قد يسد المسام ويمنع البشرة من التنفس، مما يؤدي إلى حب الشباب.', skin_notes: { oily: 'يسد المسام ويسبب البثور.', acne: 'يزيد بشكل كبير من خطر انسداد المسام وحب الشباب.' } },
            { name: ['Sulfates', 'كبريتات'], classification: 'تحذير: مهيج محتمل', description: 'منظفات قوية (مثل SLS, SLES) قد تجرد البشرة من زيوتها الطبيعية وتسبب الجفاف والتهيج.', skin_notes: { dry: 'يزيد الجفاف والتقشير.', sensitive: 'مهيج للغاية للبشرة الحساسة.' } },
            { name: ['Oxybenzone', 'أوكسي بنزون'], classification: 'تحذير: مكون ضار جداً', description: 'مرشح كيميائي للأشعة فوق البنفسجية، قد يسبب اضطرابات هرمونية وحساسية.' },
            { name: ['Triclosan', 'ترايكلوسان'], classification: 'تحذير: مكون ضار جداً', description: 'مادة مضادة للبكتيريا، قد تساهم في مقاومة المضادات الحيوية وتؤثر على الهرمونات.' },
            { name: ['Sodium Xylene Sulfonate', 'زيلين سلفونات الصوديوم'], classification: 'تحذير: مهيج محتمل', description: 'عامل رغوي ومذيب، قد يسبب تهيجًا للجلد والعينين لدى بعض الأفراد.', skin_notes: { sensitive: 'قد يسبب تهيجًا للبشرة الحساسة.' } },
            { name: ['Polyethylene Glycol', 'بولي إيثيلين جلايكول', 'PEG'], classification: 'تحذير: قد يحتوي على شوائب', description: 'مركب يستخدم كمذيب ومكثف ومرطب، قد يحتوي على شوائب ضارة إذا لم يتم تنقيته بشكل صحيح.' },
            { name: ['Ambergris', 'قيء الحوت'], classification: 'تحذير: مكون مثير للجدل', description: 'مادة نادرة تستخدم في صناعة العطور، مصدرها حيواني وتثير جدلاً أخلاقياً وبيئياً.' },

            // Product Types / Ingredient Categories (Informational)
            { name: ['Primer', 'برايمر', 'البرايمر'], classification: 'نوع منتج', description: 'منتج تجميلي يمهد البشرة ويساعد على إطالة عمر المكياج.' },
            { name: ['Foundation', 'كريم أساس', 'كريم الأساس'], classification: 'نوع منتج', description: 'منتج تجميلي يوحد لون البشرة ويوفر تغطية.' },
            { name: ['Concealer', 'كونسيلر', 'الكونسيلر'], classification: 'نوع منتج', description: 'منتج تجميلي يصحح عيوب البشرة مثل الهالات السوداء والبقع.' },
            { name: ['Contour', 'كونتور', 'الكونتور'], classification: 'نوع منتج', description: 'منتج تجميلي يمنح الوجه مظهرًا ثلاثي الأبعاد ويبرز الملامح.' },
            { name: ['Emulsifiers', 'مستحلبات'], classification: 'نوع مكون', description: 'فئة من المكونات تساعد على مزج الزيوت والماء معًا في المستحضرات.' },
            { name: ['Preservatives', 'مواد حافظة'], classification: 'نوع مكون', description: 'فئة من المكونات تمنع نمو البكتيريا والفطريات في المنتجات.' },
            { name: ['Thickeners', 'مواد مكثفة'], classification: 'نوع مكون', description: 'فئة من المكونات تجعل المستحضر أكثر كثافة وتوفر القوام المطلوب.' },
            { name: ['Moisturizers', 'مرطبات'], classification: 'نوع مكون', description: 'فئة من المكونات ترطب البشرة وتساعد على الاحتفاظ بالرطوبة.' },
            { name: ['Colorants', 'ألوان', 'أصباغ'], classification: 'نوع مكون', description: 'فئة من المكونات تضفي اللون على المنتجات التجميلية.' }
        ];

        // Functions (made global by being attached to window object)
        let activeInput = null;
        let currentSuggestionsDiv = null;

        window.showSuggestions = function(inputElement, suggestionsDiv) {
            const inputValue = inputElement.tagName === 'TEXTAREA' ? 
                               window.getLastWord(inputElement.value, inputElement.selectionStart).toLowerCase() : 
                               inputElement.value.toLowerCase();
            
            suggestionsDiv.innerHTML = ''; 
            suggestionsDiv.classList.add('hidden'); 

            if (inputValue.trim().length < 1) { 
                return;
            }

            activeInput = inputElement;
            currentSuggestionsDiv = suggestionsDiv;

            const uniqueMatchedNames = new Set();
            window.ingredientsDatabase.forEach(ingredient => { 
                ingredient.name.forEach(name => {
                    if (name.toLowerCase().includes(inputValue)) {
                        uniqueMatchedNames.add(name);
                    }
                });
            });

            if (uniqueMatchedNames.size === 0) {
                return;
            }

            const sortedSuggestions = Array.from(uniqueMatchedNames).sort((a, b) => a.localeCompare(b, 'ar', { sensitivity: 'base' }));

            sortedSuggestions.forEach(suggestion => {
                const suggestionItem = document.createElement('div');
                suggestionItem.classList.add('autocomplete-suggestion-item');
                suggestionItem.textContent = suggestion;
                suggestionItem.addEventListener('click', () => {
                    if (inputElement.tagName === 'TEXTAREA') {
                        const cursorPosition = inputElement.selectionStart;
                        const textBeforeCursor = inputElement.value.substring(0, cursorPosition);
                        const lastDelimiterIndex = Math.max(
                            textBeforeCursor.lastIndexOf(' '), 
                            textBeforeCursor.lastIndexOf(','), 
                            textBeforeCursor.lastIndexOf('\n'), 
                            textBeforeCursor.lastIndexOf('.')
                        );
                        const wordStart = lastDelimiterIndex === -1 ? 0 : lastDelimiterIndex + 1;
                        
                        const textAfterCursor = inputElement.value.substring(cursorPosition);
                        const nextDelimiterIndex = Math.min(
                            textAfterCursor.indexOf(' ') === -1 ? Infinity : textAfterCursor.indexOf(' '),
                            textAfterCursor.indexOf(',') === -1 ? Infinity : textAfterCursor.indexOf(','),
                            textAfterCursor.indexOf('\n') === -1 ? Infinity : textAfterCursor.indexOf('\n'),
                            textAfterCursor.indexOf('.') === -1 ? Infinity : textAfterCursor.indexOf('.')
                        );
                        const wordEnd = nextDelimiterIndex === Infinity ? inputElement.value.length : cursorPosition + nextDelimiterIndex;

                        inputElement.value = inputElement.value.substring(0, wordStart) + suggestion + inputElement.value.substring(wordEnd);
                        inputElement.selectionStart = inputElement.selectionEnd = wordStart + suggestion.length; 
                    } else {
                        inputElement.value = suggestion;
                    }
                    suggestionsDiv.classList.add('hidden');
                    inputElement.focus();
                });
                suggestionsDiv.appendChild(suggestionItem);
            });

            suggestionsDiv.classList.remove('hidden');
            const inputRect = inputElement.getBoundingClientRect();
            const parentRect = inputElement.parentElement.getBoundingClientRect();
            
            const rightPosition = parentRect.width - (inputRect.left - parentRect.left) - inputRect.width;
            suggestionsDiv.style.right = `${rightPosition}px`;
            suggestionsDiv.style.left = 'auto'; 
            suggestionsDiv.style.top = `${inputRect.bottom - parentRect.top + 5}px`;
            suggestionsDiv.style.width = `${inputRect.width}px`;
        }

        window.getLastWord = function(text, cursorPosition) {
            const textBeforeCursor = text.substring(0, cursorPosition);
            const lastDelimiterIndex = Math.max(
                textBeforeCursor.lastIndexOf(' '), 
                textBeforeCursor.lastIndexOf(','), 
                textBeforeCursor.lastIndexOf('\n'), 
                textBeforeCursor.lastIndexOf('.')
            );
            return textBeforeCursor.substring(lastDelimiterIndex + 1).trim(); 
        }

        document.addEventListener('click', (event) => {
            if (currentSuggestionsDiv && !currentSuggestionsDiv.contains(event.target) && activeInput && !activeInput.contains(event.target)) {
                currentSuggestionsDiv.classList.add('hidden');
            }
        });
        
        window.showMessage = function(message, type = 'info') {
            if (messageBox) { 
                messageBox.textContent = message;
                messageBox.className = `mt-4 p-2 text-sm rounded-lg ${type === 'error' ? 'bg-red-100 border-red-300 text-red-800' : 'bg-yellow-100 border-yellow-300 text-yellow-800'} block`;
                if (resultsContainer) resultsContainer.classList.add('hidden'); 
            } else {
                console.warn("Message box element not found, showing message in console:", message);
            }
        }

        window.hideMessage = function() {
            if (messageBox) { 
                messageBox.classList.add('hidden');
            }
        }

        window.addTag = function(ingredient, type, silent = false) {
            const listElement = type === 'preferred' ? preferredIngredientsList : excludedIngredientsList;
            const tagClass = type === 'preferred' ? 'tag' : 'tag tag-excluded';

            const normalizedIngredient = ingredient.toLowerCase();

            if ((type === 'preferred' && window.userPreferredIngredients.includes(normalizedIngredient)) ||
                (type === 'excluded' && window.userExcludedIngredients.includes(normalizedIngredient))) {
                if (!silent) window.showMessage(`المكون "${ingredient}" موجود بالفعل في هذه القائمة.`, 'info');
                return;
            }

            const foundInDb = window.ingredientsDatabase.some(dbIng => 
                dbIng.name.some(n => n.toLowerCase() === normalizedIngredient)
            );

            if (!foundInDb) {
                if (!silent) window.showMessage(`المكون "${ingredient}" غير معروف في قاعدة بياناتنا. يرجى إدخال مكون تجميلي محدد من الاقتراحات.`, 'error');
                return;
            }

            const tagDiv = document.createElement('div');
            tagDiv.className = tagClass;
            tagDiv.innerHTML = `
                <span>${ingredient}</span>
                <span class="tag-remove" data-ingredient="${ingredient}" data-type="${type}">&times;</span>
            `;
            listElement.appendChild(tagDiv);

            if (type === 'preferred') {
                window.userPreferredIngredients.push(normalizedIngredient);
            } else {
                window.userExcludedIngredients.push(normalizedIngredient);
            }

            if (!silent) window.showMessage(`تم إضافة "${ingredient}" إلى قائمة المكونات الـ ${type === 'preferred' ? 'مفضلة' : 'مستبعدة'}.`, 'info');
        }

        window.removeTag = function(ingredient, type) {
            const listElement = type === 'preferred' ? preferredIngredientsList : excludedIngredientsList;
            const tags = listElement.querySelectorAll('.tag');
            tags.forEach(tag => {
                if (tag.querySelector('span:first-child').textContent.toLowerCase() === ingredient.toLowerCase()) {
                    tag.remove();
                }
            });

            if (type === 'preferred') {
                window.userPreferredIngredients = window.userPreferredIngredients.filter(item => item !== ingredient.toLowerCase());
            } else {
                window.userExcludedIngredients = window.userExcludedIngredients.filter(item => item !== ingredient.toLowerCase());
            }
            window.showMessage(`تم حذف "${ingredient}" من القائمة.`, 'info');
        }

        // PWA: Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                        window.showMessage('فشل تسجيل الخدمة العاملة (Service Worker). قد لا تعمل بعض ميزات التطبيق دون اتصال. يرجى التأكد من تشغيل التطبيق عبر HTTPS.', 'error');
                    });
            });
        }

        // Ensure all DOM elements are loaded before attempting to access them
        document.addEventListener('DOMContentLoaded', (event) => {
            // Assign DOM elements to global variables
            skinTypeSelect = document.getElementById('skinType');
            skinConcernCheckboxes = document.querySelectorAll('.skin-concern-checkbox');
            userAgeInput = document.getElementById('userAge'); 
            isPregnantCheckbox = document.getElementById('isPregnant'); 
            medicalConditionsInput = document.getElementById('medicalConditionsInput'); 
            preferredIngredientInput = document.getElementById('preferredIngredientInput');
            addPreferredIngredient = document.getElementById('addPreferredIngredient');
            preferredIngredientsList = document.getElementById('preferredIngredientsList');
            excludedIngredientInput = document.getElementById('excludedIngredientInput');
            addExcludedIngredient = document.getElementById('addExcludedIngredient');
            excludedIngredientsList = document.getElementById('excludedIngredientsList');
            ingredientsInput = document.getElementById('ingredientsInput');
            analyzeButton = document.getElementById('analyzeButton');
            resultsContainer = document.getElementById('resultsContainer');
            ingredientList = document.getElementById('ingredientList');
            summary = document.getElementById('summary');
            messageBox = document.getElementById('messageBox');
            profileNameInput = document.getElementById('profileNameInput');
            existingProfilesSelect = document.getElementById('existingProfilesSelect');
            firebaseStatusDisplay = document.getElementById('firebaseStatusDisplay'); 
            imageUpload = document.getElementById('imageUpload');
            imagePreview = document.getElementById('imagePreview');
            imagePreviewContainer = document.getElementById('imagePreviewContainer');
            scanImageBtn = document.getElementById('scanImageBtn');
            scanButtonText = document.getElementById('scanButtonText');
            scanLoadingSpinner = document.getElementById('scanLoadingSpinner');
            deleteProfileBtn = document.getElementById('deleteProfileBtn');

            preferredSuggestions = document.getElementById('preferredSuggestions');
            excludedSuggestions = document.getElementById('excludedSuggestions');
            mainSuggestions = document.getElementById('mainSuggestions');

            // Dashboard elements assignment
            activeUsersCount = document.getElementById('activeUsersCount');
            adminSettings = document.getElementById('adminSettings');
            adminUserIdDisplay = document.getElementById('adminUserIdDisplay');
            globalAnnouncementInput = document.getElementById('globalAnnouncementInput');
            updateGlobalSettingsBtn = document.getElementById('updateGlobalSettingsBtn');
            globalAnnouncement = document.getElementById('globalAnnouncement');
            announcementText = document.getElementById('announcementText');


            // Help Modal elements
            const helpModal = document.getElementById('helpModal');
            const closeHelpBtn = document.getElementById('closeHelpBtn');
            const helpContent = document.getElementById('helpContent');

            // Event listeners for help modal
            if (showHelpBtn) {
                showHelpBtn.addEventListener('click', () => {
                    if (helpModal) helpModal.classList.remove('hidden');
                });
            }
            if (closeHelpBtn) {
                closeHelpBtn.addEventListener('click', () => {
                    if (helpModal) helpModal.classList.add('hidden');
                });
            }
            if (helpModal) {
                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        helpModal.classList.add('hidden');
                    }
                });
            }

            // Profile management buttons (disabled in HTML, but adding listeners for messaging)
            if (document.getElementById('saveProfileBtn')) {
                document.getElementById('saveProfileBtn').addEventListener('click', async () => { 
                    window.saveProfile(''); // Call the disabled function
                });
            }

            if (document.getElementById('loadNamedProfileBtn')) {
                document.getElementById('loadNamedProfileBtn').addEventListener('click', () => {
                    window.loadProfile('', false); // Call the disabled function
                });
            }

            if (deleteProfileBtn) {
                deleteProfileBtn.addEventListener('click', () => {
                    window.deleteProfile(''); // Call the disabled function
                });
            }

            // Event listener for updating global settings (admin, now enabled)
            if (updateGlobalSettingsBtn) {
                updateGlobalSettingsBtn.addEventListener('click', window.saveGlobalConfig);
            }

            // Autocomplete event listeners
            if (preferredIngredientInput && preferredSuggestions) {
                preferredIngredientInput.addEventListener('input', () => window.showSuggestions(preferredIngredientInput, preferredSuggestions));
                preferredIngredientInput.addEventListener('focus', () => window.showSuggestions(preferredIngredientInput, preferredSuggestions)); 
                preferredIngredientInput.addEventListener('blur', () => {
                    setTimeout(() => preferredSuggestions.classList.add('hidden'), 150); 
                });
            }
            if (excludedIngredientInput && excludedSuggestions) {
                excludedIngredientInput.addEventListener('input', () => window.showSuggestions(excludedIngredientInput, excludedSuggestions));
                excludedIngredientInput.addEventListener('focus', () => window.showSuggestions(excludedIngredientInput, excludedSuggestions)); 
                excludedIngredientInput.addEventListener('blur', () => {
                    setTimeout(() => excludedSuggestions.classList.add('hidden'), 150); 
                });
            }
            if (ingredientsInput && mainSuggestions) {
                ingredientsInput.addEventListener('input', () => window.showSuggestions(ingredientsInput, mainSuggestions));
                ingredientsInput.addEventListener('focus', () => window.showSuggestions(ingredientsInput, mainSuggestions)); 
                ingredientsInput.addEventListener('blur', () => {
                    setTimeout(() => mainSuggestions.classList.add('hidden'), 150); 
                });
            }
            
            // General event listeners for adding/removing tags
            if (addPreferredIngredient) {
                addPreferredIngredient.addEventListener('click', () => {
                    const ingredient = preferredIngredientInput.value.trim();
                    if (ingredient) {
                        window.addTag(ingredient, 'preferred');
                        preferredIngredientInput.value = '';
                    } else {
                        window.showMessage('الرجاء إدخال مكون لإضافته إلى المفضلة.', 'error');
                    }
                });
            }

            if (addExcludedIngredient) {
                addExcludedIngredient.addEventListener('click', () => {
                    const ingredient = excludedIngredientInput.value.trim();
                    if (ingredient) {
                        window.addTag(ingredient, 'excluded');
                        excludedIngredientInput.value = '';
                    } else {
                        window.showMessage('الرجاء إدخال مكون لإضافته إلى المستبعدة.', 'error');
                    }
                });
            }

            document.addEventListener('click', (event) => {
                if (event.target.classList.contains('tag-remove')) {
                    const ingredient = event.target.dataset.ingredient;
                    const type = event.target.dataset.type;
                    window.removeTag(ingredient, type);
                }
            });

            // Image Upload and Scan functionality
            if (imageUpload) {
                imageUpload.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imagePreview.src = e.target.result;
                            imagePreviewContainer.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    } else {
                        imagePreview.src = '#';
                        imagePreviewContainer.classList.add('hidden');
                    }
                });
            }

            if (scanImageBtn) {
                scanImageBtn.addEventListener('click', async () => {
                    const file = imageUpload.files[0];
                    if (!file) {
                        window.showMessage('الرجاء تحميل صورة أولاً للمسح الضوئي.', 'error');
                        return;
                    }

                    // Show loading indicator
                    scanButtonText.textContent = 'جاري المسح والتحليل...';
                    scanLoadingSpinner.classList.remove('hidden');
                    scanImageBtn.disabled = true; 

                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        const base64ImageData = reader.result.split(',')[1]; 

                        try {
                            const prompt = "من فضلك، قم باستخراج جميع المكونات التجميلية المذكورة في هذه الصورة. قم بفصل كل مكون بفاصلة. لا تقم بتضمين أي معلومات أخرى غير قائمة المكونات.";
                            let chatHistory = [];
                            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                            
                            const payload = {
                                contents: [
                                    {
                                        role: "user",
                                        parts: [
                                            { text: prompt },
                                            {
                                                inlineData: {
                                                    mimeType: file.type, 
                                                    data: base64ImageData
                                                }
                                            }
                                        ]
                                    }
                                ],
                            };

                            const apiKey = ""; 
                            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                            
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const result = await response.json();
                            
                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                const extractedText = result.candidates[0].content.parts[0].text;
                                
                                // Populate the ingredients input and trigger analysis
                                ingredientsInput.value = extractedText;
                                window.showMessage('تم استخراج المكونات بنجاح من الصورة! جاري التحليل...', 'info');
                                analyzeButton.click(); // Trigger existing analysis
                            } else {
                                window.showMessage('لم يتم العثور على مكونات في الصورة أو تنسيق الاستجابة غير متوقع.', 'error');
                            }

                        } catch (error) {
                            console.error("Error scanning image with LLM:", error);
                            window.showMessage(`فشل مسح الصورة: ${error.message}. يرجى المحاولة مرة أخرى والتأكد من وضوح النص.`, 'error');
                        } finally {
                            // Hide loading indicator
                            scanButtonText.textContent = 'مسح وتحليل المكونات من الصورة';
                            scanLoadingSpinner.classList.add('hidden');
                            scanImageBtn.disabled = false; 
                        }
                    };
                    reader.readAsDataURL(file); 
                });
            }


            if (analyzeButton) {
                analyzeButton.addEventListener('click', () => {
                    try { 
                        window.hideMessage(); 
                        ingredientList.innerHTML = ''; 
                        summary.innerHTML = ''; 
                        resultsContainer.classList.add('hidden'); 

                        const rawInput = ingredientsInput.value.trim();
                        if (!rawInput) {
                            window.showMessage('الرجاء إدخال قائمة المكونات لتحليلها.');
                            return;
                        }

                        const selectedSkinType = skinTypeSelect.value;
                        const selectedSkinConcerns = Array.from(skinConcernCheckboxes)
                                                        .filter(checkbox => checkbox.checked)
                                                        .map(checkbox => checkbox.value);
                        const userAge = parseInt(userAgeInput.value, 10);
                        const isPregnant = isPregnantCheckbox.checked;
                        const medicalConditionsText = medicalConditionsInput.value.toLowerCase(); 

                        const inputIngredients = rawInput.split(/[,;\n.]/).map(item => item.trim()).filter(item => item.length > 0);

                        if (inputIngredients.length === 0) {
                            window.showMessage('لم يتم العثور على مكونات صالحة في الإدخال.');
                            return;
                        }

                        let goodCount = 0;
                        let warningCount = 0;
                        let organicCount = 0;
                        let veryHarmfulCount = 0;
                        let analyzedCount = 0;
                        let hasExcludedIngredient = false;
                        let personalizedSkinNotes = [];
                        let skinSuitabilityScore = 0;

                        inputIngredients.forEach(inputIng => {
                            const isExcluded = window.userExcludedIngredients.includes(inputIng.toLowerCase());
                            if (isExcluded) {
                                hasExcludedIngredient = true;
                                skinSuitabilityScore -= 5;
                            }

                            const foundIngredient = window.ingredientsDatabase.find(dbIng => 
                                dbIng.name.some(n => n.toLowerCase() === inputIng.toLowerCase())
                            );

                            const ingredientItem = document.createElement('div');
                            ingredientItem.className = 'flex items-start gap-3';

                            let iconSvg = `<svg class="w-6 h-6 text-gray-400 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`; 
                            let textColorClass = 'text-gray-800';
                            let classificationText = 'غير معروف';
                            let descriptionText = 'لا تتوفر معلومات لهذا المكون في قاعدة بياناتنا الحالية.';
                            let isPreferred = window.userPreferredIngredients.includes(inputIng.toLowerCase());
                            let skinSpecificNoteHtml = '';
                            
                            const relevantNotes = []; 

                            if (foundIngredient) {
                                analyzedCount++;
                                classificationText = foundIngredient.classification;
                                descriptionText = foundIngredient.description;

                                if (foundIngredient.skin_notes) {
                                    if (foundIngredient.skin_notes[selectedSkinType]) {
                                        const note = foundIngredient.skin_notes[selectedSkinType];
                                        const skinTypeName = selectedSkinType === 'normal' ? 'عادية' : selectedSkinType === 'oily' ? 'الدهنية' : selectedSkinType === 'dry' ? 'جافة' : selectedSkinType === 'combination' ? 'مختلطة' : 'الحساسة';
                                        relevantNotes.push({ text: `ملاحظة لبشرتك ${skinTypeName}: ${note}`, type: selectedSkinType });
                                    }
                                    selectedSkinConcerns.forEach(concern => {
                                        if (foundIngredient.skin_notes[concern]) {
                                            const note = foundIngredient.skin_notes[concern];
                                            const concernName = concern === 'acne' ? 'حب الشباب' : concern === 'aging' ? 'الشيخوخة' : concern === 'pigmentation' ? 'التصبغات' : concern === 'redness' ? 'الاحمرار' : 'الجفاف';
                                            relevantNotes.push({ text: `ملاحظة لاهتمام ${concernName}: ${note}`, type: concern });
                                        }
                                    });
                                }

                                if (!isNaN(userAge) && userAge > 0 && foundIngredient.age_notes) {
                                    relevantNotes.push({ text: `ملاحظة للعمر: ${foundIngredient.age_notes}`, type: 'age', negative: true });
                                }
                                
                                if (isPregnant && foundIngredient.pregnancy_notes) {
                                    relevantNotes.push({ text: `ملاحظة للحمل: ${foundIngredient.pregnancy_notes}`, type: 'pregnancy', negative: true });
                                }

                                if (medicalConditionsText && foundIngredient.medical_notes) {
                                    foundIngredient.medical_notes.forEach(note => {
                                        if (medicalConditionsText.includes(note.keyword.toLowerCase())) {
                                            relevantNotes.push({ text: `ملاحظة لحالتك الصحية (${note.keyword}): ${note.text}`, type: 'medical', negative: true });
                                        }
                                    });
                                }

                                relevantNotes.forEach(noteObj => {
                                    const noteText = noteObj.text;
                                    let noteColorClass = 'text-fuchsia-600'; 

                                    if (noteText.includes('يسد المسام') || noteText.includes('يزيد من حب الشباب') || noteText.includes('مهيج') || noteText.includes('يزيد الجفاف') || noteText.includes('تفاقم') || noteText.includes('تجنبه تماماً') || noteText.includes('لا يفضل') || noteObj.negative) {
                                        noteColorClass = 'text-red-600'; 
                                        skinSuitabilityScore -= (noteObj.type === 'pregnancy' || noteObj.type === 'age' || noteObj.type === 'medical') ? 4 : 2; 
                                    } else if (noteText.includes('ممتاز') || noteText.includes('يساعد') || noteText.includes('يقلل') || noteText.includes('مهدئ') || noteText.includes('يعزز') || noteText.includes('مفيد') || noteText.includes('لطيف') || noteText.includes('توازن')) {
                                        noteColorClass = 'text-green-600'; 
                                    }

                                    skinSpecificNoteHtml += `<span class="block text-xs ${noteColorClass} font-medium mt-1">${noteText}</span>`;
                                    personalizedSkinNotes.push(`- ${inputIng} (${noteObj.type === 'normal' ? 'عادية' : noteObj.type === 'oily' ? 'دهنية' : noteObj.type === 'dry' ? 'جافة' : noteObj.type === 'combination' ? 'مختلطة' : noteObj.type === 'sensitive' ? 'حساسة' : noteObj.type === 'acne' ? 'حب الشباب' : noteObj.type === 'aging' ? 'الشيخوخة' : noteObj.type === 'pigmentation' ? 'التصبغات' : noteObj.type === 'redness' ? 'الاحمرار' : noteObj.type === 'dehydration' ? 'الجفاف' : noteObj.type === 'age' ? 'العمر' : noteObj.type === 'pregnancy' ? 'الحمل' : noteObj.type === 'medical' ? 'الحالة الصحية' : ''}): ${noteText}`);
                                });


                                if (foundIngredient.classification.includes('جيد للبشرة')) {
                                    iconSvg = `<svg class="w-6 h-6 text-emerald-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;
                                    textColorClass = 'text-emerald-700';
                                    goodCount++;
                                    skinSuitabilityScore += 1; 
                                } else if (foundIngredient.classification.includes('تحذير: مكون ضار جداً')) {
                                    iconSvg = `<svg class="w-6 h-6 text-red-700 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`;
                                    textColorClass = 'text-red-900';
                                    veryHarmfulCount++;
                                    warningCount++;
                                    skinSuitabilityScore -= 3; 
                                } else if (foundIngredient.classification.includes('تحذير: مهيج محتمل') || foundIngredient.classification.includes('مثير للجدل') || foundIngredient.classification.includes('انسداد المسام') || foundIngredient.classification.includes('قد يحتوي على شوائب')) {
                                    iconSvg = `<svg class="w-6 h-6 text-amber-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.487 0L14.82 10.5c.765 1.36-.217 3-1.743 3H6.923c-1.526 0-2.508-1.64-1.743-3L8.257 3.099zM10 16a1 1 0 100-2 1 1 0 000 2zm0-5a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`;
                                    textColorClass = 'text-amber-700';
                                    warningCount++;
                                    skinSuitabilityScore -= 1; 
                                } else if (foundIngredient.classification.includes('عضوي')) {
                                    iconSvg = `<svg class="w-6 h-6 text-lime-600 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9V7h2v6zm4 0h-2V7h2v6z"/></svg>`;
                                    textColorClass = 'text-lime-800';
                                    organicCount++;
                                    goodCount++;
                                    skinSuitabilityScore += 1; 
                                } else if (foundIngredient.classification.includes('نوع منتج') || foundIngredient.classification.includes('نوع مكون')) {
                                    iconSvg = `<svg class="w-6 h-6 text-sky-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-1-11a1 1 0 10-2 0v4a1 1 0 102 0V7zm3 1a1 1 0 10-2 0v3a1 1 0 102 0V8z" clip-rule="evenodd"></path></svg>`;
                                    textColorClass = 'text-sky-700';
                                }
                            }

                            let personalizedNote = '';
                            if (isExcluded) {
                                iconSvg = `<svg class="w-6 h-6 text-red-700 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>`;
                                textColorClass = 'text-red-900 font-bold';
                                personalizedNote = '<span class="text-xs text-red-600 mr-2">(مستبعد في تفضيلاتك!)</span>';
                            } else if (isPreferred) {
                                iconSvg = `<svg class="w-6 h-6 text-blue-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;
                                textColorClass = 'text-blue-800 font-bold';
                                personalizedNote = '<span class="text-xs text-blue-600 mr-2">(مكون مفضل لك!)</span>';
                                skinSuitabilityScore += 1; 
                            }

                            ingredientItem.innerHTML = `
                                <div class="flex-shrink-0">
                                    ${iconSvg}
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-base ${textColorClass}">${inputIng} ${personalizedNote} <span class="text-xs font-normal text-gray-500">(${classificationText})</span></p>
                                    <p class="text-sm text-gray-600">${descriptionText} ${skinSpecificNoteHtml}</p>
                                </div>
                            `;
                            ingredientList.appendChild(ingredientItem);
                        });

                        let recommendationTitle = '';
                        let recommendationMessage = '';
                        let recommendationClass = '';

                        if (skinSuitabilityScore < -5 || veryHarmfulCount > 0 || hasExcludedIngredient) {
                            recommendationTitle = 'قد لا يكون هذا المنتج الأفضل لبشرتك.';
                            recommendationMessage = `يحتوي على ${veryHarmfulCount > 0 ? `مكونات ضارة جداً (${veryHarmfulCount})` : ''} ${hasExcludedIngredient ? `و/أو مكونات قمت بتحديدها كمستبعدة.` : ''} يفضل تجنب المنتجات التي تحتوي على هذه المكونات إذا كانت بشرتك حساسة أو تعاني من مشاكل محددة أو في ظروف خاصة (مثل الحمل/العمر).`;
                            recommendationClass = 'bg-red-100 border-red-400 text-red-700';
                        } else if (skinSuitabilityScore >= 3 && warningCount === 0) { 
                            recommendationTitle = 'مناسب جداً لبشرتك!';
                            recommendationMessage = 'يبدو أن هذا المنتج يحتوي على العديد من المكونات المفيدة والمتوافقة مع نوع بشرتك واهتماماتك، مع عدد قليل جداً أو لا يوجد أي مكونات تحتاج إلى انتباه.';
                            recommendationClass = 'bg-green-100 border-green-400 text-green-700';
                        } else if (skinSuitabilityScore >= 0) { 
                            recommendationTitle = 'مناسب بشكل عام لبشرتك مع بعض التحفظات.';
                            recommendationMessage = 'يحتوي هذا المنتج على مكونات جيدة، ولكن قد يتضمن أيضاً بعض المكونات التي قد لا تكون مثالية تماماً لنوع بشرتك أو اهتماماتك أو عمرك/حالتك. يُنصح بمراجعة الملاحظات الفردية لكل مكون.';
                            recommendationClass = 'bg-yellow-100 border-yellow-400 text-yellow-800';
                        } else { 
                            recommendationTitle = 'قد لا يكون هذا المنتج مثالياً لبشرتك.';
                            recommendationMessage = 'على الرغم من عدم احتوائه على مكونات ضارة جداً، إلا أن هذا المنتج يضم مكونات قد لا تتوافق بشكل كبير مع احتياجات بشرتك أو قد تثير بعض اهتماماتك أو عمرك/حالتك. راجع التحليل المفصل للمكونات.';
                            recommendationClass = 'bg-orange-100 border-orange-400 text-orange-700';
                        }

                        if (analyzedCount > 0) {
                            let topMessage = '';
                            if (hasExcludedIngredient || veryHarmfulCount > 0 || personalizedSkinNotes.some(note => note.includes('تجنبه تماماً') || note.includes('لا يفضل') || note.includes('غير آمن للحمل') || note.includes('ملاحظة للعمر'))) {
                                topMessage = `<div class="p-3 mb-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center font-bold text-base">
                                                تنبيه: قد يحتوي هذا المنتج على مكونات غير مناسبة بناءً على ملفك الشخصي أو تفضيلاتك!
                                            </div>`;
                            }
                            
                            let skinProfileSummary = '';
                            if (personalizedSkinNotes.length > 0) {
                                skinProfileSummary = `
                                    <h3 class="text-lg font-bold text-fuchsia-700 mt-4 mb-2 text-center">ملاحظات شخصية لبشرتك:</h3>
                                    <ul class="list-disc list-inside text-gray-700 text-right mx-auto max-w-md space-y-0.5 text-sm">
                                        ${personalizedSkinNotes.map(note => `<li>${note}</li>`).join('')}
                                    </ul>
                                `;
                            }

                            summary.innerHTML = `
                                ${topMessage}
                                <div class="p-3 rounded-lg ${recommendationClass} mb-3 text-center">
                                    <h3 class="font-bold text-base">${recommendationTitle}</h3>
                                    <p class="text-xs">${recommendationMessage}</p>
                                </div>
                                <p class="text-base">تم تحليل <strong>${analyzedCount}</strong> مكونًا من إجمالي <strong>${inputIngredients.length}</strong> مكونات تم إدخالها.</p>
                                <p class="text-base">المكونات الجيدة: <strong class="text-emerald-700">${goodCount}</strong></p>
                                <p class="text-base">المكونات العضوية/الطبيعية: <strong class="text-lime-800">${organicCount}</strong></p>
                                <p class="text-base">المكونات التي تحتاج إلى انتباه: <strong class="text-amber-700">${warningCount}</strong></p>
                                <p class="text-base ${veryHarmfulCount > 0 ? 'font-bold text-red-900' : 'text-gray-700'}">المكونات الضارة جداً: <strong>${veryHarmfulCount}</strong></p>
                                ${skinProfileSummary}
                            `;
                            resultsContainer.classList.remove('hidden'); 
                        } else {
                            window.showMessage('لم يتم العثور على أي مكونات معروفة في قاعدة البيانات الحالية.');
                            resultsContainer.classList.add('hidden'); 
                        }
                    } catch (error) {
                        console.error("An error occurred during analysis:", error);
                        window.showMessage('حدث خطأ أثناء تحليل المكونات. يرجى التأكد من صحة الإدخال والمحاولة مرة أخرى.', 'error');
                    }
                });
            }
        }); 
    </script>
</body>
</html>
