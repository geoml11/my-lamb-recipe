<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة مقارنة المكونات الذكي (نسخة المسؤول)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for Inter font */
        html, body {
            height: 100%; /* Ensure html and body take full height */
        }
        body {
            font-family: 'Inter', sans-serif;
            direction: rtl; /* Ensure right-to-left for Arabic */
            text-align: right; /* Align text to the right for Arabic */
            min-height: 100vh; /* Ensure body takes full viewport height */
            display: flex; /* Use flexbox for body */
            flex-direction: column; /* Stack children vertically */
            align-items: center; /* Center horizontally */
            padding-top: 5rem; /* Add sufficient padding at the top for buttons */
            padding-bottom: 2rem; /* Add padding at the bottom */
            padding-left: 1rem; /* Padding on sides for small screens */
            padding-right: 1rem;
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        /* Adjust alignment for specific elements if needed */
        .text-center {
            text-align: center;
        }

        /* Custom scrollbar for textarea */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for selected tags */
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #d1fae5; /* Green-100 */
            color: #065f46; /* Green-800 */
            border-radius: 9999px; /* Full rounded */
            padding: 0.25rem 0.75rem; /* py-1 px-3 */
            margin: 0.25rem;
            font-size: 0.875rem; /* text-sm */
            white-space: nowrap; /* Prevent tags from wrapping */
        }
        .tag-remove {
            margin-right: 0.5rem; /* Adjusted for RTL */
            cursor: pointer;
            color: #065f46;
            font-weight: bold;
        }
        .tag-excluded {
            background-color: #fee2e2; /* Red-100 */
            color: #991b1b; /* Red-800 */
        }
        .tag-excluded .tag-remove {
            color: #991b1b;
        }

        /* Autocomplete suggestions styling */
        .autocomplete-suggestions {
            position: absolute;
            z-index: 100;
            background-color: #ffffff;
            border: 1px solid #e2e8f0; /* gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            width: 100%; /* Ensure it spans the width of the input */
            text-align: right; /* RTL alignment */
        }
        .autocomplete-suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            font-size: 0.875rem; /* text-sm */
            color: #4a5568; /* gray-700 */
        }
        .autocomplete-suggestion-item:hover {
            background-color: #f0f4f8; /* gray-100 */
        }
        .autocomplete-suggestion-item.active { /* For keyboard navigation */
            background-color: #e2e8f0; /* gray-200 */
        }
        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #34d399; /* emerald-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Message Box Styling - Enhanced for visibility */
        #messageBox {
            position: fixed; /* Ensures it stays in place even when scrolling */
            top: 2rem; /* Position from the top */
            right: 1rem; /* Position from the right (for RTL) */
            left: 1rem; /* Position from the left (for RTL) */
            z-index: 1000; /* High z-index to ensure it's on top of other content */
            max-width: 90%; /* Adjust width for smaller screens */
            margin: 0 auto; /* Center it horizontally */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* Stronger shadow for prominence */
            transition: opacity 0.3s ease-in-out; /* Smooth transition for hiding/showing */
            opacity: 0; /* Initially hidden with opacity */
            pointer-events: none; /* Allows clicks to pass through when hidden */
        }

        #messageBox.show {
            opacity: 1; /* Show it by changing opacity */
            pointer-events: auto; /* Enable clicks when shown */
        }
        /* New: Styling for quick lookup result */
        #quickSearchResult {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            font-size: 0.875rem; /* text-sm */
            background-color: #f0f4f8; /* gray-100 */
            border: 1px solid #e2e8f0; /* gray-200 */
        }
        #quickSearchResult.found {
            background-color: #ecfdf5; /* emerald-50 */
            border-color: #a7f3d0; /* emerald-200 */
            color: #047857; /* emerald-700 */
        }
        #quickSearchResult.not-found {
            background-color: #fef2f2; /* red-50 */
            border-color: #fecaca; /* red-200 */
            color: #dc2626; /* red-700 */
        }
        #quickSearchResult h3 {
            font-weight: 600; /* font-semibold */
            margin-bottom: 0.5rem;
        }
        #quickSearchResult p {
            margin-bottom: 0.25rem;
        }

        /* Custom Confirmation Modal Styles */
        #confirmationModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than messageBox */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }
        #confirmationModal.show {
            opacity: 1;
            visibility: visible;
        }
        #confirmationModalContent {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        #confirmationModal.show #confirmationModalContent {
            transform: translateY(0);
        }
        #confirmationModalButtons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* Collapsible Section Styles */
        .collapsible-header {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #e0f2f7; /* Light blue-gray for headers */
            color: #0c4a6e; /* Darker blue-gray text */
            border-radius: 0.75rem; /* rounded-xl */
            margin-bottom: 0.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background-color 0.3s ease, border-color 0.3s ease;
            border: 1px solid #a7d9ee; /* Light border */
        }
        .collapsible-header:hover {
            background-color: #d1ecf4; /* Lighter hover */
        }
        .collapsible-header.active {
            background-color: #a7d9ee; /* Active header color */
            border-color: #4fb3e3; /* Darker active border */
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out, opacity 0.5s ease-out;
            opacity: 0;
            padding: 0 1rem; /* Adjust padding for collapsed state */
            box-sizing: border-box;
        }
        .collapsible-content.open {
            max-height: 1000px; /* Arbitrary large value, adjust as needed */
            opacity: 1;
            padding: 1rem; /* Restore padding when open */
            margin-bottom: 1rem; /* Add margin after content */
            border: 1px solid #d1ecf4; /* Light border around open content */
            border-top: none; /* No top border, as header has one */
            border-radius: 0 0 0.75rem 0.75rem; /* Rounded only at bottom */
            background-color: white; /* Content background */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Shadow below content */
        }

        .collapsible-header svg.icon-arrow {
            transition: transform 0.3s ease;
        }
        .collapsible-header.active svg.icon-arrow {
            transform: rotate(90deg); /* Rotate arrow when open (for RTL) */
        }
        .collapsible-header .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        .collapsible-header .section-title svg {
            width: 1.5rem;
            height: 1.5rem;
        }
    </style>
    <!-- PWA: Link to manifest.json (removed for local file system CORS issue) -->
    <!-- <link rel="manifest" href="/manifest.json"> -->
    <!-- PWA: Add Apple touch icon for iOS -->
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    <!-- PWA: Set theme color for browser UI -->
    <meta name="theme-color" content="#4ADE80"/>

    <!-- Google AdSense - Main Script (Place this in the <head> section) -->
    <!-- REPLACE 'ca-pub-YOUR_ADSENSE_PUBLISHER_ID' with your actual AdSense Publisher ID -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6230858794160580"
          crossorigin="anonymous"></script>
</head>
<body class="bg-gradient-to-br from-green-50 to-emerald-100">
    <!-- Help Button - Always visible -->
    <button id="showHelpBtn" class="absolute top-4 left-4 bg-blue-600 text-white py-2 px-3 rounded-full shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-300 z-50 flex items-center gap-1 text-sm">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8_0 11-16 0 8 8_0 0116 0zm-7-4a1 1_0 11-2 0 1 1_0 012 0zm-1 9a1 1_0 100-2 1 1_0 000 2zm1-5a1 1_0 10-2 0V9a1 1_0 102 0v1z" clip-rule="evenodd"></path>
        </svg>
        <span class="font-semibold">مساعدة</span>
    </button>

    <!-- Sign In/Sign Out Button - New -->
    <button id="signInSignOutBtn" class="absolute top-4 right-4 bg-gray-600 text-white py-2 px-3 rounded-full shadow-lg hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300 z-50 flex items-center gap-1 text-sm">
        <span class="font-semibold">جاري التحقق...</span>
    </button>

    <!-- Main Application Content (Always visible now) -->
    <div id="mainAppContent" class="w-full max-w-2xl mx-auto p-4 md:p-6 bg-white rounded-2xl shadow-xl border border-green-200 relative">
        <!-- Hero Section -->
        <div class="text-center mb-6 pb-4 border-b border-green-200">
            <h1 class="text-3xl font-extrabold text-emerald-800 mb-2 leading-tight">
                اكتشف سر بشرتك وشعرك مع <br><span class="text-emerald-600">محلل المكونات الذكي</span>
            </h1>
            <p class="text-base text-gray-700 max-w-md mx-auto">
                أداة بسيطة لمساعدتك على فهم مكونات منتجات العناية بالبشرة والشعر. الصق القائمة ودعنا نكشف لك الحقائق!
            </p>
        </div>

        <!-- Collapsible Section: Dashboard -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="dashboardContent">
                <span class="section-title">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10v11h18V10M3 10L12 3l9 7M3 10h18"></path>
                    </svg>
                    لوحة التحكم
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="dashboardContent" class="collapsible-content open">
                <div class="p-4 bg-indigo-50 rounded-xl shadow-sm border border-indigo-200">
                    <h2 class="text-xl font-bold text-indigo-700 mb-3 text-center">لوحة التحكم</h2>
                    <p class="text-sm text-gray-700 mb-2 text-center">
                        <span class="font-semibold">عدد المستخدمين النشطين:</span> <span id="activeUsersCount" class="font-mono text-indigo-800 text-lg">0</span>
                    </p>
                    <div id="globalAnnouncement" class="p-2 bg-blue-100 border border-blue-400 text-blue-800 rounded-lg text-center mt-3 hidden text-sm">
                        <p class="font-semibold">إعلان عام:</p>
                        <p id="announcementText" class="italic"></p>
                    </div>
                    
                    <!-- Admin settings are now always visible in this admin version -->
                    <div id="adminSettings" class="mt-4 p-3 bg-indigo-100 rounded-lg border border-indigo-300 hidden"> <!-- Initially hidden, but made visible by JS -->
                        <h3 class="text-lg font-bold text-indigo-700 mb-2 text-center">إعدادات المسؤول (تحديد إعلان عام)</h3>
                        <p class="text-xs text-gray-700 mb-3 text-center">
                            معرف المستخدم الخاص بك: <span id="adminUserIdDisplay" class="font-mono text-indigo-800 break-all"></span>
                        </p>
                        <div class="mb-3">
                            <label for="globalAnnouncementInput" class="block text-gray-700 text-xs font-semibold mb-1">رسالة الإعلان العامة:</label>
                            <input type="text" id="globalAnnouncementInput" class="w-full p-2 text-sm border border-indigo-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 ease-in-out" placeholder="اكتب إعلانًا يظهر للجميع هنا">
                        </div>
                        <button id="updateGlobalSettingsBtn" class="w-full bg-indigo-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300 shadow-md text-sm" disabled>
                            حفظ الإعدادات العامة
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Dashboard -->

        <!-- Google AdSense - Example Ad Unit 1 (Below Dashboard but outside accordion) -->
        <div class="my-6 p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200 text-center">
            <p class="text-sm text-gray-600 mb-2">إعلان (من Google AdSense)</p>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-6230858794160580"
                 data-ad-slot="2613256240" <!--  تم تحديث هذا الرقم بمعرف الوحدة الإعلانية الذي قدمته  -->
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>

        <!-- Collapsible Section: Save/Load Profile -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="saveLoadProfileContent">
                <span class="section-title">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    إدارة ملفاتك الشخصية
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="saveLoadProfileContent" class="collapsible-content">
                <div class="p-4 bg-purple-50 rounded-xl shadow-sm border border-purple-200">
                    <h2 class="text-xl font-bold text-purple-700 mb-3 text-center">إدارة ملفاتك الشخصية</h2>
                    <p class="text-xs text-gray-700 mb-2 text-center">
                        <span class="font-semibold">معرف المستخدم الخاص بك:</span> <span id="userIdDisplay" class="font-mono text-purple-800 break-all">جاري الاتصال...</span>
                        <br>
                        <span class="font-semibold">حالة Firebase:</span> <span id="firebaseStatusDisplay" class="font-mono text-purple-800 break-all">جاري التحقق...</span>
                    </p>

                    <div class="mb-3">
                        <label for="profileNameInput" class="block text-gray-700 text-sm font-semibold mb-1">اسم ملف التعريف (للحفظ/التحميل):</label>
                        <input type="text" id="profileNameInput" class="w-full p-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 ease-in-out" placeholder="مثال: ملف بشرتي وشعري اليومي">
                    </div>

                    <div class="flex flex-col sm:flex-row gap-3 justify-center mb-3">
                        <button id="saveProfileBtn" class="bg-purple-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-300 shadow-md text-sm" disabled>
                            حفظ الملف الحالي
                        </button>
                        <button id="loadNamedProfileBtn" class="bg-purple-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-300 shadow-md text-sm" disabled>
                            تحميل الملف المحدد
                        </button>
                        <button id="deleteProfileBtn" class="bg-red-600 text-white py-2 px-3 rounded-lg font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-300 shadow-md text-sm" disabled>
                            حذف الملف المحدد
                        </button>
                    </div>

                    <div>
                        <label for="existingProfilesSelect" class="block text-gray-700 text-sm font-semibold mb-1">الملفات المحفوظة:</label>
                        <select id="existingProfilesSelect" class="w-full p-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200 ease-in-out" disabled>
                            <option value="">لا توجد ملفات شخصية محفوظة</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Save/Load Profile -->

        <!-- Collapsible Section: Scan Ingredients from Image -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="scanImageContent">
                <span class="section-title">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    مسح المكونات من صورة
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="scanImageContent" class="collapsible-content">
                <div class="p-4 bg-yellow-50 rounded-xl shadow-sm border border-yellow-200">
                    <h2 class="text-xl font-bold text-yellow-700 mb-3 text-center">مسح المكونات من صورة عبوة المنتج</h2>
                    <p class="text-sm text-gray-700 mb-3 text-center">
                        يمكنك تحميل صورة لعبوة المنتج (تأكد أن قائمة المكونات واضحة) وسنقوم بتحليلها لك تلقائياً.
                    </p>
                    <div class="mb-3">
                        <label for="imageUpload" class="block text-gray-700 text-sm font-semibold mb-1">
                            تحميل صورة عبوة المنتج:
                        </label>
                        <input type="file" id="imageUpload" accept="image/*" class="w-full p-2 text-sm border border-yellow-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 transition duration-200 ease-in-out">
                    </div>
                    <div id="imagePreviewContainer" class="mb-3 text-center hidden">
                        <img id="imagePreview" src="#" alt="معاينة الصورة" class="max-w-full h-auto rounded-lg shadow-md mx-auto">
                    </div>
                    <button id="scanImageBtn" class="w-full bg-yellow-600 text-white py-2.5 px-3 rounded-lg font-semibold hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition duration-300 shadow-md hover:shadow-lg flex items-center justify-center text-sm">
                        <span id="scanButtonText">مسح وتحليل المكونات من الصورة</span>
                        <span id="scanLoadingSpinner" class="loader hidden"></span>
                    </button>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Scan Ingredients from Image -->

        <!-- Collapsible Section: Quick Ingredient Lookup -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="quickLookupContent">
                <span class="section-title">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    البحث السريع عن مكون واحد
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="quickLookupContent" class="collapsible-content">
                <div class="p-4 bg-green-50 rounded-xl shadow-sm border border-green-200">
                    <h2 class="text-xl font-bold text-green-700 mb-3 text-center">البحث السريع عن مكون واحد</h2>
                    <p class="text-sm text-gray-700 mb-3 text-center">
                        اكتب اسماً لأي مكون لتحصل على معلومات فورية عنه بناءً على ملفك الشخصي.
                    </p>
                    <div class="flex relative mb-3">
                        <input type="text" id="quickIngredientSearchInput" class="flex-1 p-2 text-sm border border-green-300 rounded-l-lg rounded-r-none focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200 ease-in-out" placeholder="مثال: Niacinamide / نياسيناميد">
                        <button id="quickSearchBtn" class="bg-green-600 text-white py-2 px-3 rounded-r-lg rounded-l-none font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-300 ease-in-out text-sm">
                            بحث
                        </button>
                        <div id="quickSearchSuggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                    <div id="quickSearchResult" class="hidden">
                        <!-- Results will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Quick Ingredient Lookup -->

        <!-- Google AdSense - Example Ad Unit 2 (Before Skin Profile) -->
        <div class="my-6 p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200 text-center">
            <p class="text-sm text-gray-600 mb-2">إعلان (من Google AdSense)</p>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-6230858794160580"
                 data-ad-slot="2209382827" <!--  تم تحديث هذا الرقم بمعرف الوحدة الإعلانية الثانية الذي قدمته  -->
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>

        <!-- Collapsible Section: Suggest New Ingredients (New Section) -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="suggestIngredientContent">
                <span class="section-title">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    اقتراح مكونات جديدة
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="suggestIngredientContent" class="collapsible-content">
                <div class="p-4 bg-lime-50 rounded-xl shadow-sm border border-lime-200">
                    <h2 class="text-xl font-bold text-lime-700 mb-3 text-center">اقتراح مكون لم يدرج بعد</h2>
                    <p class="text-sm text-gray-700 mb-3 text-center">
                        إذا لم تجد مكوناً في قوائم الإكمال التلقائي، يمكنك اقتراحه هنا. سيتم مراجعته وإضافته لاحقاً.
                    </p>
                    <div class="mb-3">
                        <label for="newIngredientSuggestionInput" class="block text-gray-700 text-sm font-semibold mb-1">
                            اسم المكون المقترح:
                        </label>
                        <input type="text" id="newIngredientSuggestionInput" class="w-full p-2 text-sm border border-lime-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-lime-500 transition duration-200 ease-in-out" placeholder="مثال: Ceramide NP">
                    </div>
                    <button id="submitNewIngredientSuggestionBtn" class="w-full bg-lime-600 text-white py-2.5 px-3 rounded-lg font-semibold hover:bg-lime-700 focus:outline-none focus:ring-2 focus:ring-lime-500 focus:ring-offset-2 transition duration-300 shadow-md hover:shadow-lg flex items-center justify-center text-sm">
                        <span id="suggestButtonText">إرسال الاقتراح</span>
                        <span id="suggestLoadingSpinner" class="loader hidden"></span>
                    </button>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Suggest New Ingredients -->

        <!-- Collapsible Section: Skin Profile -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="skinProfileContent">
                <span class="section-title">
                    <!-- Updated Skin Profile Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4.125 4.125 0 100 7.792 4.125 4.125 0 000-7.792zM1.5 21a.75.75 0 01.75-.75h18a.75.75 0 01.75.75v.75a.75.75 0 01-.75.75H2.25a.75.75 0 01-.75-.75v-.75z"></path>
                    </svg>
                    ملفك الشخصي للبشرة
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="skinProfileContent" class="collapsible-content">
                <div class="p-4 bg-fuchsia-50 rounded-xl shadow-sm border border-fuchsia-200">
                    <h2 class="text-xl font-bold text-fuchsia-700 mb-3 text-center">ملفك الشخصي للبشرة</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label for="skinType" class="block text-gray-700 text-sm font-semibold mb-1">نوع بشرتك:</label>
                            <select id="skinType" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out">
                                <option value="normal">عادية</option>
                                <option value="oily">دهنية</option>
                                <option value="dry">جافة</option>
                                <option value="combination">مختلطة</option>
                                <option value="sensitive">حساسة</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-1">اهتمامات بشرتك:</label>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                                    <input type="checkbox" value="acne" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded skin-concern-checkbox ml-1">
                                    <span>حب الشباب</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                                    <input type="checkbox" value="aging" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded skin-concern-checkbox ml-1">
                                    <span>الشيخوخة/التجاعيد</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                                    <input type="checkbox" value="pigmentation" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded ml-1">
                                    <span>التصبغات</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                                    <input type="checkbox" value="redness" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded ml-1">
                                    <span>الاحمرار</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors">
                                    <input type="checkbox" value="dehydration" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded ml-1">
                                    <span>الجفاف</span>
                                </label>
                            </div>
                        </div>
                        <!-- Existing fields for age, pregnancy, and medical conditions -->
                        <div>
                            <label for="userAge" class="block text-gray-700 text-sm font-semibold mb-1">عمرك:</label>
                            <input type="number" id="userAge" min="1" max="120" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out" placeholder="أدخل عمرك">
                        </div>
                        <div class="md:col-span-2"> <!-- Span full width for this checkbox -->
                            <label class="inline-flex items-center p-1.5 rounded-full bg-fuchsia-100 text-fuchsia-800 cursor-pointer hover:bg-fuchsia-200 transition-colors text-xs">
                                <input type="checkbox" id="isPregnant" class="form-checkbox text-fuchsia-600 h-3.5 w-3.5 rounded ml-1">
                                <span>هل أنت حامل؟</span>
                            </label>
                        </div>
                        <div class="md:col-span-2"> <!-- Span full width for this textarea -->
                            <label for="medicalConditionsInput" class="block text-gray-700 text-sm font-semibold mb-1">أمراض أو حالات صحية معينة (اختياري، مثل السكري، أمراض الكلى):</label>
                            <textarea id="medicalConditionsInput" rows="2" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out resize-y" placeholder="مثال: سكري، أمراض الكلى، حساسية الجلوتين"></textarea>
                        </div>
                        <!-- New fields for Height and Ideal Weight -->
                        <div>
                            <label for="userHeightCm" class="block text-gray-700 text-sm font-semibold mb-1">طولك (سم):</label>
                            <input type="number" id="userHeightCm" min="50" max="250" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out" placeholder="أدخل طولك بالسنتيمتر">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-1">الوزن المثالي (تقديري):</label>
                            <p id="idealWeightDisplay" class="w-full p-2 text-sm bg-fuchsia-100 border border-fuchsia-300 rounded-lg text-fuchsia-800 font-medium">
                                أدخل طولك للحساب
                            </p>
                        </div>
                        <!-- New fields for Current Weight and Date -->
                        <div>
                            <label for="currentWeightKg" class="block text-gray-700 text-sm font-semibold mb-1">وزنك الحالي (كجم):</label>
                            <input type="number" id="currentWeightKg" min="1" max="500" step="0.1" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out" placeholder="أدخل وزنك الحالي">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-1">المتبقي للوصول للوزن المثالي:</label>
                            <p id="weightToIdealDisplay" class="w-full p-2 text-sm bg-fuchsia-100 border border-fuchsia-300 rounded-lg text-fuchsia-800 font-medium">
                                أدخل طولك ووزنك للحساب
                            </p>
                        </div>
                        <div class="md:col-span-2"> <!-- Span full width for the date input -->
                            <label for="measurementDate" class="block text-gray-700 text-sm font-semibold mb-1">تاريخ القياس:</label>
                            <input type="date" id="measurementDate" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out">
                        </div>
                        <!-- New textarea for Skin Care Notes -->
                        <div class="md:col-span-2">
                            <label for="skinCareNotes" class="block text-gray-700 text-sm font-semibold mb-1">ملاحظات العناية بالبشرة:</label>
                            <textarea id="skinCareNotes" rows="5" class="w-full p-2 text-sm border border-fuchsia-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-fuchsia-500 transition duration-200 ease-in-out resize-y" placeholder="أضف منتجات العناية بالبشرة أو الملاحظات هنا..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Skin Profile -->

        <!-- Collapsible Section: Hair Profile -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="hairProfileContent">
                <span class="section-title">
                    <!-- Updated Hair Profile Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2.25c-3.155 0-5.834 1.493-7.536 3.817a.75.75 0 001.107.919c.928-1.404 2.44-2.502 4.279-2.502 1.839 0 3.351 1.098 4.279 2.502a.75.75 0 001.107-.919C17.834 3.743 15.155 2.25 12 2.25zm.75 14.25a.75.75 0 00-.75.75v2.25a.75.75 0 001.5 0v-2.25a.75.75 0 00-.75-.75zM8.25 17.25a.75.75 0 00-.75.75v2.25a.75.75 0 001.5 0v-2.25a.75.75 0 00-.75-.75zM15.75 17.25a.75.75 0 00-.75.75v2.25a.75.75 0 001.5 0v-2.25a.75.75 0 00-.75-.75z"></path>
                    </svg>
                    ملفك الشخصي للشعر
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="hairProfileContent" class="collapsible-content">
                <div class="p-4 bg-rose-50 rounded-xl shadow-sm border border-rose-200">
                    <h2 class="text-xl font-bold text-rose-700 mb-3 text-center">ملفك الشخصي للشعر</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label for="hairType" class="block text-gray-700 text-sm font-semibold mb-1">نوع شعرك:</label>
                            <select id="hairType" class="w-full p-2 text-sm border border-rose-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500 transition duration-200 ease-in-out">
                                <option value="straight">أملس</option>
                                <option value="wavy">متموج</option>
                                <option value="curly">كيرلي</option>
                                <option value="coily">أفرو / مجعد جداً</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm font-semibold mb-1">اهتمامات شعرك:</label>
                            <div class="flex flex-wrap gap-2 text-xs">
                                <label class="inline-flex items-center p-1.5 rounded-full bg-rose-100 text-rose-800 cursor-pointer hover:bg-rose-200 transition-colors">
                                    <input type="checkbox" value="dryness" class="form-checkbox text-rose-600 h-3.5 w-3.5 rounded hair-concern-checkbox ml-1">
                                    <span>جفاف</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-rose-100 text-rose-800 cursor-pointer hover:bg-rose-200 transition-colors">
                                    <input type="checkbox" value="oiliness" class="form-checkbox text-rose-600 h-3.5 w-3.5 rounded hair-concern-checkbox ml-1">
                                    <span>دهنية</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-rose-100 text-rose-800 cursor-pointer hover:bg-rose-200 transition-colors">
                                    <input type="checkbox" value="frizz" class="form-checkbox text-rose-600 h-3.5 w-3.5 rounded hair-concern-checkbox ml-1">
                                    <span>تجعد (Frizz)</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-rose-100 text-rose-800 cursor-pointer hover:bg-rose-200 transition-colors">
                                    <input type="checkbox" value="damage" class="form-checkbox text-rose-600 h-3.5 w-3.5 rounded hair-concern-checkbox ml-1">
                                    <span>تلف</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-rose-100 text-rose-800 cursor-pointer hover:bg-rose-200 transition-colors">
                                    <input type="checkbox" value="hair_loss" class="form-checkbox text-rose-600 h-3.5 w-3.5 rounded hair-concern-checkbox ml-1">
                                    <span>تساقط</span>
                                </label>
                                <label class="inline-flex items-center p-1.5 rounded-full bg-rose-100 text-rose-800 cursor-pointer hover:bg-rose-200 transition-colors">
                                    <input type="checkbox" value="scalp_sensitivity" class="form-checkbox text-rose-600 h-3.5 w-3.5 rounded hair-concern-checkbox ml-1">
                                    <span>حساسية فروة الرأس</span>
                                </label>
                            </div>
                        </div>
                        <!-- New textarea for Hair Care Notes -->
                        <div class="md:col-span-2">
                            <label for="hairCareNotes" class="block text-gray-700 text-sm font-semibold mb-1">ملاحظات العناية بالشعر:</label>
                            <textarea id="hairCareNotes" rows="5" class="w-full p-2 text-sm border border-rose-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-rose-500 transition duration-200 ease-in-out resize-y" placeholder="أضف منتجات العناية بالشعر أو الملاحظات هنا..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Hair Profile -->

        <!-- Collapsible Section: Preferred & Excluded Ingredients -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="ingredientsPreferencesContent">
                <span class="section-title">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18a.75.75 0 110-1.5.75.75 0 010 1.5zM5.25 12h5.25M5.25 7.5h5.25M5.25 16.5h5.25"></path>
                    </svg>
                    تفضيلاتك الشخصية للمكونات
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="ingredientsPreferencesContent" class="collapsible-content">
                <div class="p-4 bg-sky-50 rounded-xl shadow-sm border border-sky-200">
                    <h2 class="text-xl font-bold text-sky-700 mb-3 text-center">تفضيلاتك الشخصية للمكونات</h2>

                    <div class="mb-4">
                        <label for="preferredIngredientInput" class="block text-gray-700 text-sm font-semibold mb-1">
                            أضف مكوناتك المفضلة (مكون واحد لكل إضافة):
                        </label>
                        <div class="flex relative"> <!-- Added 'relative' here for autocomplete positioning -->
                            <input type="text" id="preferredIngredientInput" class="flex-1 p-2 text-sm border border-sky-300 rounded-l-lg rounded-r-none focus:outline-none focus:ring-2 focus:ring-sky-500 transition duration-200 ease-in-out" placeholder="مثال: Niacinamide / نياسيناميد">
                            <button id="addPreferredIngredient" class="bg-sky-600 text-white py-2 px-3 rounded-r-lg rounded-l-none font-semibold hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 transition duration-300 ease-in-out text-sm">
                                أضف
                            </button>
                            <!-- حاوية الاقتراحات للإكمال التلقائي للمكونات المفضلة -->
                            <div id="preferredSuggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                        <div id="preferredIngredientsList" class="mt-2 flex flex-wrap gap-2 justify-end">
                            </div>
                    </div>

                    <div>
                        <label for="excludedIngredientInput" class="block text-gray-700 text-sm font-semibold mb-1">
                            أضف مكوناتك المستبعدة/المتحسس منها:
                        </label>
                        <div class="flex relative"> <!-- Added 'relative' here for autocomplete positioning -->
                            <input type="text" id="excludedIngredientInput" class="flex-1 p-2 text-sm border border-red-300 rounded-l-lg rounded-r-none focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200 ease-in-out" placeholder="مثال: Parfum / عطور">
                            <button id="addExcludedIngredient" class="bg-red-600 text-white py-2 px-3 rounded-r-lg rounded-l-none font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-300 ease-in-out text-sm">
                                أضف
                            </button>
                            <!-- حاوية الاقتراحات للإكمال التلقائي للمكونات المستبعدة -->
                            <div id="excludedSuggestions" class="autocomplete-suggestions hidden"></div>
                        </div>
                        <div id="excludedIngredientsList" class="mt-2 flex flex-wrap gap-2 justify-end">
                            </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Preferred & Excluding Ingredients -->

        <!-- Collapsible Section: Ingredient Analysis Input -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="ingredientAnalysisInputContent">
                <span class="section-title">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    تحليل المكونات
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="ingredientAnalysisInputContent" class="collapsible-content">
                <div class="p-4"> <!-- Removed bg color from here to apply only to .collapsible-content.open -->
                    <label for="ingredientsInput" class="block text-gray-700 text-sm font-semibold mb-1">
                        الصق قائمة المكونات هنا (كل مكون في سطر جديد، أو افصل بفاصلة):
                    </label>
                    <div class="relative"> <!-- Added 'relative' here for autocomplete positioning -->
                        <textarea id="ingredientsInput" rows="8" class="w-full p-2 text-sm border border-emerald-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 transition duration-200 ease-in-out resize-y" placeholder="مثال:&#10;Water, Glycerin, Niacinamide, Butylene Glycol, Caprylic/Capric Triglyceride, Squalane, Cetearyl Alcohol, ..."></textarea>
                        <div id="mainIngredientSuggestions" class="autocomplete-suggestions hidden"></div>
                    </div>
                    <button id="analyzeIngredientsBtn" class="mt-4 w-full bg-emerald-600 text-white py-3 px-4 rounded-lg font-bold hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition duration-300 shadow-lg hover:shadow-xl flex items-center justify-center">
                        <span id="analyzeButtonText">تحليل المكونات</span>
                        <span id="analyzeLoadingSpinner" class="loader hidden"></span>
                    </button>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Ingredient Analysis Input -->

        <!-- Collapsible Section: Analysis Results -->
        <div class="mb-2">
            <button class="collapsible-header" data-target="analysisResultsContent">
                <span class="section-title">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v2m-2-5v5m12-9v9m-2-5v5M9 5V3m-2 5V3m12 8V9m-2 5V9M9 13a3 3 0 100-6 3 3 0 000 6zm0 0v1m0 0v4m0 0h4m-4 0H5a2 2 0 00-2 2v2a2 2 0 002 2h14a2 2 0 002-2v-2a2 2 0 00-2-2h-3"></path>
                    </svg>
                    نتائج التحليل
                </span>
                <svg class="w-5 h-5 icon-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <div id="analysisResultsContent" class="collapsible-content">
                <div id="analysisResults" class="p-6 bg-emerald-50 rounded-2xl shadow-inner border border-emerald-300">
                    <h2 class="text-2xl font-bold text-emerald-700 mb-4 text-center">نتائج التحليل</h2>
                    <div class="space-y-4 text-sm text-gray-800">
                        <div id="ingredientSummary" class="bg-white p-4 rounded-lg shadow-sm border border-emerald-200">
                            <h3 class="font-semibold text-emerald-600 mb-2">ملخص المكونات:</h3>
                            <p id="summaryText">سيظهر الملخص هنا.</p>
                        </div>
                        <div id="ingredientBreakdown" class="bg-white p-4 rounded-lg shadow-sm border border-emerald-200">
                            <h3 class="font-semibold text-emerald-600 mb-2">تفصيل المكونات:</h3>
                            <ul id="breakdownList" class="list-disc pr-5"></ul>
                        </div>
                        <div id="preferredMatch" class="bg-white p-4 rounded-lg shadow-sm border border-emerald-200">
                            <h3 class="font-semibold text-emerald-600 mb-2">تطابق المكونات المفضلة:</h3>
                            <ul id="preferredMatchList" class="list-disc pr-5"></ul>
                        </div>
                        <div id="excludedMatch" class="bg-white p-4 rounded-lg shadow-sm border border-emerald-200">
                            <h3 class="font-semibold text-emerald-600 mb-2">تطابق المكونات المستبعدة:</h3>
                            <ul id="excludedMatchList" class="list-disc pr-5"></ul>
                        </div>
                        <div id="recommendations" class="bg-white p-4 rounded-lg shadow-sm border border-emerald-200">
                            <h3 class="font-semibold text-emerald-600 mb-2">توصيات مخصصة:</h3>
                            <p id="recommendationsText">ستظهر التوصيات هنا.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Collapsible Section: Analysis Results -->

        <!-- Google AdSense - Example Ad Unit 3 (Bottom) -->
        <div class="my-6 p-4 bg-gray-50 rounded-xl shadow-sm border border-gray-200 text-center">
            <p class="text-sm text-gray-600 mb-2">إعلان (من Google AdSense)</p>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-6230858794160580"
                 data-ad-slot="6401308075" <!--  تم تحديث هذا الرقم بمعرف الوحدة الإعلانية الثالث الذي قدمته  -->
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
        </div>

    </div>
    <!-- Custom Message Box -->
    <div id="messageBox" class="bg-white rounded-lg p-4 shadow-xl flex items-center justify-between text-gray-800 border border-gray-200" style="max-width: 400px;">
        <span id="messageText" class="text-sm font-medium"></span>
        <button id="closeMessageBox" class="text-gray-500 hover:text-gray-700 focus:outline-none ml-3">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmationModal" class="hidden">
        <div id="confirmationModalContent" class="bg-white p-6 rounded-lg shadow-lg text-center">
            <p id="confirmationMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div id="confirmationModalButtons">
                <button id="confirmYesBtn" class="bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition duration-300">
                    نعم
                </button>
                <button id="confirmNoBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition duration-300">
                    إلغاء
                </button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection, query, getDocs, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Firebase Configuration - يرجى استبدال هذه القيم ببيانات مشروعك الحقيقية من Firebase Console
        // كيفية الحصول على هذه البيانات:
        // 1. اذهب إلى Firebase Console (console.firebase.google.com).
        // 2. اختر مشروعك.
        // 3. في لوحة التحكم، انقر على أيقونة الإعدادات (الترس) بجوار "Project overview" ثم "Project settings".
        // 4. في قسم "Your apps"، انقر على "</>" (تطبيق ويب). إذا لم يكن لديك تطبيق ويب، قم بإنشاء واحد.
        // 5. ستظهر لك بيانات التهيئة في كائن JavaScript، انسخها والصقها هنا.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                // **************************************************************************************************
                // *** تم تحديث هذه القيم بناءً على معلومات مشروعك الفعلية من Firebase Console.                 ***
                // **************************************************************************************************
                apiKey: "AIzaSyBvZ1yofJAiUNgbBeRSlqhhhfvI7rFlYbQ", // تم تحديث مفتاح API هنا
                authDomain: "skin-99c39.firebaseapp.com",
                databaseURL: "https://skin-99c39-default-rtdb.firebaseio.com",
                projectId: "skin-99c39", // تم تصحيح projectId ليطابق authDomain و appId
                storageBucket: "skin-99c39.firebasestorage.app",
                messagingSenderId: "111983738514",
                appId: "1:111983738514:web:27712c903e739cebb3304b",
                measurementId: "G-GQ34RLMGS0"
                // **************************************************************************************************
                // *** توقف عن التغيير هنا.                                                  ***
                // **************************************************************************************************
            };

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Initialization
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let userProfileRef;
        let globalSettingsRef;
        let activeUsersCollectionRef;
        let ingredientSuggestionsCollectionRef; // New Firestore collection reference
        let isFirebaseInitialized = false; // Flag to track Firebase initialization status
        let isAdmin = false; // New flag to track admin status

        /**
         * Displays a custom message box with a given message and optional type.
         * @param {string} message - The message to display.
         * @param {string} [type='info'] - The type of message ('info', 'success', 'error', 'warning').
         */
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = message;

            // Reset classes
            messageBox.className = 'bg-white rounded-lg p-4 shadow-xl flex items-center justify-between text-gray-800 border border-gray-200';
            messageBox.classList.add('show'); // Always show on new message

            // Apply type-specific styles
            switch (type) {
                case 'success':
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    break;
                case 'error':
                    messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    break;
                case 'warning':
                    messageBox.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-700');
                    break;
                case 'info':
                default:
                    messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
                    break;
            }

            // Hide after 5 seconds
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000);
        }

        // Close message box button listener
        document.getElementById('closeMessageBox').addEventListener('click', () => {
            document.getElementById('messageBox').classList.remove('show');
        });

        /**
         * Shows a custom confirmation modal.
         * @param {string} message The message to display in the confirmation modal.
         * @returns {Promise<boolean>} A promise that resolves to true if confirmed, false otherwise.
         */
        function showConfirmationModal(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmationModal');
                const modalMessage = document.getElementById('confirmationMessage');
                const confirmYesBtn = document.getElementById('confirmYesBtn');
                const confirmNoBtn = document.getElementById('confirmNoBtn');

                modalMessage.textContent = message;
                modal.classList.add('show');

                const handleConfirm = () => {
                    modal.classList.remove('show');
                    confirmYesBtn.removeEventListener('click', handleConfirm);
                    confirmNoBtn.removeEventListener('click', handleCancel);
                    resolve(true);
                };

                const handleCancel = () => {
                    modal.classList.remove('show');
                    confirmYesBtn.removeEventListener('click', handleConfirm);
                    confirmNoBtn.removeEventListener('click', handleCancel);
                    resolve(false);
                };

                confirmYesBtn.addEventListener('click', handleConfirm);
                confirmNoBtn.addEventListener('click', handleCancel);
            });
        }


        // Initialize Firebase
        // Only attempt to initialize if firebaseConfig has actual project ID
        // التحقق من أن بيانات التهيئة ليست قيمًا افتراضية (YOUR_PROJECT_ID) قبل التهيئة
        function initFirebase() {
            if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    isFirebaseInitialized = true; // Set flag to true on successful initialization

                    // Firestore references
                    // Path for global settings: artifacts/{appId}/public/data/globalSettings/currentSettings
                    // Path for active users: artifacts/{appId}/public/data/activeUsers/{userId}
                    // Path for ingredient suggestions: artifacts/{appId}/public/data/ingredientSuggestions/{docId}
                    globalSettingsRef = doc(collection(db, `artifacts/${appId}/public/data/globalSettings`), 'currentSettings');
                    activeUsersCollectionRef = collection(db, `artifacts/${appId}/public/data/activeUsers`);
                    ingredientSuggestionsCollectionRef = collection(db, `artifacts/${appId}/public/data/ingredientSuggestions`);


                    console.log("Firebase initialized successfully.");

                    // *** Moved onAuthStateChanged listener here, after auth is initialized ***
                    onAuthStateChanged(auth, async (user) => {
                        const signInSignOutBtn = document.getElementById('signInSignOutBtn');
                        const adminSettingsDiv = document.getElementById('adminSettings');
                        const updateGlobalSettingsButton = document.getElementById('updateGlobalSettingsBtn');

                        if (user) {
                            userId = user.uid;
                            document.getElementById('userIdDisplay').textContent = userId;
                            document.getElementById('adminUserIdDisplay').textContent = userId;
                            console.log("Current User ID (user.uid):", userId); // Log the user ID
                            
                            // Determine admin status:
                            // For a developer/creator within the Canvas environment, we can force isAdmin to true
                            // to ensure access to admin features for testing and management.
                            // In a production environment, this logic should be based on user roles from a database.
                            isAdmin = true; // FORCE ADMIN STATUS FOR CANVAS CREATOR

                            // Only proceed with Firestore operations if 'db' is successfully initialized
                            if (db) {
                                // userProfileRef must be set AFTER userId is confirmed
                                // Path for user profiles: artifacts/{appId}/users/{userId}/profiles/{profileName}
                                userProfileRef = doc(db, `artifacts/${appId}/users/${userId}/profiles/myProfile`);

                                // Enable profile buttons after authentication for any user
                                document.getElementById('saveProfileBtn').disabled = false;
                                document.getElementById('loadNamedProfileBtn').disabled = false;
                                document.getElementById('deleteProfileBtn').disabled = false;
                                document.getElementById('existingProfilesSelect').disabled = false;
                                document.getElementById('submitNewIngredientSuggestionBtn').disabled = false; // Enable suggest button

                                if (isAdmin) {
                                    adminSettingsDiv.classList.remove('hidden'); // Show admin settings
                                    updateGlobalSettingsButton.disabled = false; // Enable admin button
                                    document.getElementById('firebaseStatusDisplay').textContent = 'متصل (مدير)';
                                    signInSignOutBtn.textContent = 'تسجيل الخروج (مدير)';
                                } else {
                                    adminSettingsDiv.classList.add('hidden'); // Hide admin settings
                                    updateGlobalSettingsButton.disabled = true; // Disable admin button
                                    document.getElementById('firebaseStatusDisplay').textContent = 'متصل (مستخدم عادي)';
                                    signInSignOutBtn.textContent = 'تسجيل الدخول';
                                }

                                await recordActiveUser();
                                await loadUserProfile();
                                await loadExistingProfiles(); // Load existing profiles for the dropdown
                                await loadGlobalSettings(); // Load global settings for all users
                                listenToActiveUsers();
                            } else {
                                // This case means auth succeeded but db failed to initialize (e.g., config missing)
                                showMessage("Firebase Firestore غير مهيأ. بعض الميزات قد لا تعمل.", 'warning');
                            }
                        } else {
                            // User is signed out (anonymous or logged out)
                            userId = 'anonymous'; // Reset userId if signed out
                            document.getElementById('userIdDisplay').textContent = 'غير مصادق';
                            document.getElementById('adminUserIdDisplay').textContent = 'غير مصادق';
                            console.log("Authentication state: Unauthenticated (anonymous).");
                            showMessage("غير مصادق. بعض الميزات التي تتطلب تسجيل الدخول لن تعمل.", 'warning');

                            // Disable all profile/admin/suggestion buttons
                            document.getElementById('saveProfileBtn').disabled = true;
                            document.getElementById('loadNamedProfileBtn').disabled = true;
                            document.getElementById('deleteProfileBtn').disabled = true;
                            document.getElementById('existingProfilesSelect').disabled = true;
                            document.getElementById('updateGlobalSettingsBtn').disabled = true;
                            document.getElementById('submitNewIngredientSuggestionBtn').disabled = true; // Disable suggest button
                            adminSettingsDiv.classList.add('hidden'); // Hide admin settings
                            document.getElementById('firebaseStatusDisplay').textContent = 'غير متصل';
                            signInSignOutBtn.textContent = 'تسجيل الدخول'; // Change button text
                            isAdmin = false; // Reset admin status
                        }
                    });

                } catch (e) {
                    console.error("Error initializing Firebase:", e);
                    showMessage(`خطأ في تهيئة Firebase: ${e.message}. يرجى التحقق من إعدادات Firebase الخاصة بك.`, 'error');
                    document.getElementById('firebaseStatusDisplay').textContent = 'خطأ في الاتصال';
                    document.getElementById('signInSignOutBtn').textContent = 'خطأ';
                }
            } else {
                console.warn("Firebase configuration is missing or empty or still using placeholder. Firestore functionality will be limited.");
                showMessage("لم يتم تهيئة Firebase. قد لا تعمل بعض الميزات أو حفظ البيانات. لتشغيل كامل، يرجى إضافة تهيئة Firebase الخاصة بك في الكود.", 'warning');
                document.getElementById('firebaseStatusDisplay').textContent = 'غير متاح (لا يوجد تهيئة)';
                document.getElementById('signInSignOutBtn').textContent = 'تكوين Firebase!';
            }
        }

        // --- Firebase Authentication and User Management ---
        async function authenticateUser() {
            // Ensure Firebase is initialized before attempting authentication
            if (!isFirebaseInitialized || !auth) {
                console.warn("Firebase Auth is not initialized. Cannot authenticate.");
                showMessage("خدمة المصادقة غير مهيأة.", 'error');
                return;
            }

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Logged in using custom token.");
                    showMessage("تم تسجيل الدخول كمسؤول.", 'success');
                } else {
                    await signInAnonymously(auth);
                    console.log("Logged in anonymously.");
                    showMessage("تم تسجيل الدخول كمستخدم عادي (مجهول).", 'info');
                }
            } catch (error) {
                console.error("Authentication error:", error);
                showMessage(`فشل المصادقة: ${error.message}`, 'error');
            }
        }

        // Function to handle sign-in/sign-out button click
        async function handleSignInSignOut() {
            if (auth.currentUser) {
                // If logged in, sign out
                try {
                    await signOut(auth); // Use signOut from firebase/auth
                    showMessage("تم تسجيل الخروج بنجاح.", 'info');
                } catch (error) {
                    console.error("Error signing out:", error);
                    showMessage(`خطأ في تسجيل الخروج: ${error.message}`, 'error');
                }
            } else {
                // If logged out, sign in (anonymously or with custom token if available)
                await authenticateUser();
            }
        }

        // Record active users in Firestore (Public Data)
        async function recordActiveUser() {
            if (!db || !userId || userId === 'anonymous') return; // Ensure db is available
            const userDocRef = doc(activeUsersCollectionRef, userId);
            try {
                await setDoc(userDocRef, {
                    lastActive: new Date().toISOString(),
                    role: isAdmin ? 'admin' : 'user', // Store role
                }, { merge: true });
                console.log(`User ${userId} active status updated, role: ${isAdmin ? 'admin' : 'user'}.`);
            } catch (e) {
                console.error("Error recording active user:", e);
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (للبيانات العامة):                                              ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين القراءة والكتابة لمجموعة 'public/data' (مثل 'activeUsers' و 'globalSettings')،      ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/public/data/{document=**} { allow read, write: if request.auth != null; } ***
                // *** ***
                // **************************************************************************************************
            }
        }

        // Listen to active users count (Public Data)
        function listenToActiveUsers() {
            if (!db) return; // Ensure db is available
            onSnapshot(activeUsersCollectionRef, (snapshot) => {
                const activeUsers = [];
                snapshot.forEach(doc => {
                    activeUsers.push(doc.id);
                });
                document.getElementById('activeUsersCount').textContent = activeUsers.length;
                console.log("Active users:", activeUsers.length);
            }, (error) => {
                console.error("Error listening to active users:", error);
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (للبيانات العامة):                                              ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين القراءة لمجموعة 'public/data' (مثل 'activeUsers' و 'globalSettings')،                 ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/public/data/{document=**} { allow read, write: if request.auth != null; } ***
                // *** ***
                // **************************************************************************************************
            });
        }

        // --- Profile Management Functions ---
        async function saveUserProfile(profileName) {
            if (!db || !userId || userId === 'anonymous' || !userProfileRef) {
                showMessage("يرجى تسجيل الدخول أو الاتصال بالإنترنت لحفظ ملفك الشخصي.", 'error');
                return;
            }

            if (!profileName) {
                showMessage("الرجاء إدخال اسم لملفك الشخصي للحفظ.", 'warning');
                return;
            }

            const skinConcerns = Array.from(document.querySelectorAll('.skin-concern-checkbox:checked')).map(cb => cb.value);
            const hairConcerns = Array.from(document.querySelectorAll('.hair-concern-checkbox:checked')).map(cb => cb.value);
            const preferredIngredients = Array.from(document.querySelectorAll('#preferredIngredientsList .tag span:first-child')).map(span => span.textContent);
            const excludedIngredients = Array.from(document.querySelectorAll('#excludedIngredientsList .tag span:first-child')).map(span => span.textContent);

            const profileData = {
                profileName: profileName,
                skinType: document.getElementById('skinType').value,
                skinConcerns: skinConcerns,
                userAge: parseInt(document.getElementById('userAge').value) || null,
                isPregnant: document.getElementById('isPregnant').checked,
                medicalConditions: document.getElementById('medicalConditionsInput').value,
                userHeightCm: parseInt(document.getElementById('userHeightCm').value) || null,
                currentWeightKg: parseFloat(document.getElementById('currentWeightKg').value) || null,
                measurementDate: document.getElementById('measurementDate').value,
                hairType: document.getElementById('hairType').value,
                hairConcerns: hairConcerns,
                preferredIngredients: preferredIngredients,
                excludedIngredients: excludedIngredients,
                skinCareNotes: document.getElementById('skinCareNotes').value, // New field
                hairCareNotes: document.getElementById('hairCareNotes').value, // New field
                lastSaved: new Date().toISOString()
            };

            try {
                // Ensure the docRef points to a document under the user's profiles collection
                const docRef = doc(collection(db, `artifacts/${appId}/users/${userId}/profiles`), profileName);
                await setDoc(docRef, profileData, { merge: true });
                showMessage(`تم حفظ الملف الشخصي "${profileName}" بنجاح!`, 'success');
                await loadExistingProfiles(); // Refresh the dropdown
            } catch (e) {
                console.error("Error saving profile:", e);
                showMessage(`خطأ في حفظ الملف الشخصي: ${e.message}`, 'error');
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (لبيانات المستخدم الخاصة):                                      ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين القراءة والكتابة لبيانات المستخدم الخاصة به (الملفات الشخصية)،                     ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/users/{userId}/{document=**} { allow read, write: if request.auth != null && request.auth.uid == userId; } ***
                // *** ***
                // **************************************************************************************************
            }
        }

        async function loadUserProfile(profileName = null) {
            if (!db || !userId || userId === 'anonymous') {
                // This might be called before auth is ready, which is fine for initial setup
                return;
            }

            let docToLoadRef;
            if (profileName) {
                docToLoadRef = doc(collection(db, `artifacts/${appId}/users/${userId}/profiles`), profileName);
            } else {
                // Default to 'myProfile' if no specific profileName is provided
                docToLoadRef = doc(db, `artifacts/${appId}/users/${userId}/profiles/myProfile`);
            }

            try {
                const docSnap = await getDoc(docToLoadRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('profileNameInput').value = data.profileName || '';
                    document.getElementById('skinType').value = data.skinType || 'normal';
                    document.getElementById('userAge').value = data.userAge || '';
                    document.getElementById('isPregnant').checked = data.isPregnant || false;
                    document.getElementById('medicalConditionsInput').value = data.medicalConditions || '';
                    document.getElementById('userHeightCm').value = data.userHeightCm || '';
                    document.getElementById('currentWeightKg').value = data.currentWeightKg || '';
                    document.getElementById('measurementDate').value = data.measurementDate || '';
                    document.getElementById('hairType').value = data.hairType || 'straight';
                    document.getElementById('skinCareNotes').value = data.skinCareNotes || 'أضف منتجات العناية بالبشرة أو الملاحظات هنا...'; // Load new field
                    document.getElementById('hairCareNotes').value = data.hairCareNotes || 'أضف منتجات العناية بالشعر أو الملاحظات هنا...'; // Load new field

                    // Set skin concerns checkboxes
                    document.querySelectorAll('.skin-concern-checkbox').forEach(cb => {
                        cb.checked = data.skinConcerns && data.skinConcerns.includes(cb.value);
                    });
                    // Set hair concerns checkboxes
                    document.querySelectorAll('.hair-concern-checkbox').forEach(cb => {
                        cb.checked = data.hairConcerns && data.hairConcerns.includes(cb.value);
                    });

                    // Clear and re-add preferred ingredients
                    document.getElementById('preferredIngredientsList').innerHTML = '';
                    if (data.preferredIngredients) {
                        data.preferredIngredients.forEach(ingredient => {
                            addTag('preferredIngredientsList', ingredient);
                        });
                    }
                    // Clear and re-add excluded ingredients
                    document.getElementById('excludedIngredientsList').innerHTML = '';
                    if (data.excludedIngredients) {
                        data.excludedIngredients.forEach(ingredient => {
                            addTag('excludedIngredientsList', ingredient, 'excluded');
                        });
                    }
                    calculateIdealWeight(); // Recalculate after loading height
                    calculateWeightToIdeal(); // Recalculate after loading weights

                    if (profileName) {
                        showMessage(`تم تحميل الملف الشخصي "${profileName}" بنجاح!`, 'success');
                    }
                } else {
                    if (profileName) {
                        showMessage(`الملف الشخصي "${profileName}" غير موجود.`, 'warning');
                    } else {
                        console.log("No 'myProfile' found, creating a default one.");
                        // Only create a default profile if db is available
                        if (db) {
                             await setDoc(docToLoadRef, { // Use docToLoadRef which is already 'myProfile'
                                profileName: 'ملفي الشخصي الافتراضي',
                                skinType: 'normal',
                                skinConcerns: [],
                                userAge: null,
                                isPregnant: false,
                                medicalConditions: '',
                                userHeightCm: null,
                                currentWeightKg: null,
                                measurementDate: '',
                                hairType: 'straight',
                                hairConcerns: [],
                                preferredIngredients: [],
                                excludedIngredients: [],
                                skinCareNotes: 'أضف منتجات العناية بالبشرة أو الملاحظات هنا...',
                                hairCareNotes: 'أضف منتجات العناية بالشعر أو الملاحظات هنا...',
                                lastSaved: new Date().toISOString()
                            });
                            await loadUserProfile(); // Load the newly created default profile
                        }
                    }
                }
            } catch (e) {
                console.error("Error loading profile:", e);
                showMessage(`خطأ في تحميل الملف الشخصي: ${e.message}`, 'error');
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (لبيانات المستخدم الخاصة):                                      ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين القراءة لبيانات المستخدم الخاصة به (الملفات الشخصية)،                               ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/users/{userId}/{document=**} { allow read, write: if request.auth != null && request.auth.uid == userId; } ***
                // *** ***
                // **************************************************************************************************
            }
        }

        async function loadExistingProfiles() {
            if (!db || !userId || userId === 'anonymous') return;
            const selectElement = document.getElementById('existingProfilesSelect');
            selectElement.innerHTML = '<option value="">لا توجد ملفات شخصية محفوظة</option>'; // Clear existing options

            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/profiles`));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    // No need to show message here, as the default option is "No saved profiles"
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const option = document.createElement('option');
                    option.value = doc.id; // doc.id is the profile name
                    option.textContent = doc.id;
                    selectElement.appendChild(option);
                });
            } catch (e) {
                console.error("Error fetching existing profiles:", e);
                showMessage(`خطأ في جلب الملفات الشخصية المحفوظة: ${e.message}`, 'error');
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (لبيانات المستخدم الخاصة):                                      ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين القراءة لبيانات المستخدم الخاصة به (الملفات الشخصية)،                               ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/users/{userId}/{document=**} { allow read, write: if request.auth != null && request.auth.uid == userId; } ***
                // *** ***
                // **************************************************************************************************
            }
        }

        async function deleteUserProfile(profileName) {
            if (!db || !userId || userId === 'anonymous' || !profileName) {
                showMessage("يرجى تسجيل الدخول واختيار ملف شخصي للحذف.", 'error');
                return;
            }
            if (profileName === 'myProfile') {
                showMessage("لا يمكنك حذف الملف الشخصي الافتراضي 'myProfile'.", 'warning');
                return;
            }

            const confirmed = await showConfirmationModal(`هل أنت متأكد أنك تريد حذف الملف الشخصي "${profileName}"؟`);
            if (!confirmed) {
                showMessage("تم إلغاء عملية الحذف.", 'info');
                return;
            }

            try {
                const docRef = doc(collection(db, `artifacts/${appId}/users/${userId}/profiles`), profileName);
                await deleteDoc(docRef);
                showMessage(`تم حذف الملف الشخصي "${profileName}" بنجاح!`, 'success');
                await loadExistingProfiles(); // Refresh the dropdown
                document.getElementById('profileNameInput').value = ''; // Clear input after deletion
                // Optionally load default profile or clear fields
            } catch (e) {
                console.error("Error deleting profile:", e);
                showMessage(`خطأ في حذف الملف الشخصي: ${e.message}`, 'error');
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (لبيانات المستخدم الخاصة):                                      ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين الحذف لبيانات المستخدم الخاصة به (الملفات الشخصية)،                               ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/users/{userId}/{document=**} { allow read, write: if request.auth != null && request.auth.uid == userId; } ***
                // *** ***
                // **************************************************************************************************
            }
        }


        // --- Global Settings (Admin) ---
        async function loadGlobalSettings() {
            if (!db || !globalSettingsRef) return; // Ensure db is available
            try {
                const docSnap = await getDoc(globalSettingsRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.announcement) {
                        document.getElementById('announcementText').textContent = data.announcement;
                        document.getElementById('globalAnnouncement').classList.remove('hidden');
                    } else {
                        document.getElementById('globalAnnouncement').classList.add('hidden');
                    }
                    document.getElementById('globalAnnouncementInput').value = data.announcement || '';
                }
            } catch (e) {
                console.error("Error loading global settings:", e);
                showMessage(`خطأ في تحميل الإعدادات العامة: ${e.message}`, 'error');
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (للبيانات العامة):                                              ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين القراءة لمجموعة 'public/data' (مثل 'activeUsers' و 'globalSettings')،                 ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/public/data/{document=**} { allow read, write: if request.auth != null; } ***
                // *** ***
                // **************************************************************************************************
            }
        }

        async function updateGlobalSettings() {
            if (!db || !userId || userId === 'anonymous' || !globalSettingsRef || !isAdmin) { // Added isAdmin check
                showMessage("لا يمكنك تحديث الإعدادات العامة بدون مصادقة كمسؤول.", 'error');
                return;
            }

            const announcementText = document.getElementById('globalAnnouncementInput').value;
            try {
                await setDoc(globalSettingsRef, { announcement: announcementText }, { merge: true });
                showMessage("تم تحديث الإعلان العام بنجاح!", 'success');
                await loadGlobalSettings(); // Refresh display
            } catch (e) {
                console.error("Error updating global settings:", e);
                showMessage(`خطأ في تحديث الإعدادات العامة: ${e.message}`, 'error');
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (للبيانات العامة):                                              ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين الكتابة لمجموعة 'public/data' (مثل 'activeUsers' و 'globalSettings')،                ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/public/data/{document=**} { allow read, write: if request.auth != null; } ***
                // *** ***
                // **************************************************************************************************
            }
        }

        // --- Core Logic: Ingredient Analysis (Placeholder) ---
        async function analyzeIngredients() {
            const ingredientsInput = document.getElementById('ingredientsInput').value;
            if (!ingredientsInput.trim()) {
                showMessage("الرجاء إدخال قائمة المكونات لتحليلها.", 'warning');
                return;
            }

            const analyzeButton = document.getElementById('analyzeIngredientsBtn');
            const analyzeButtonText = document.getElementById('analyzeButtonText');
            const analyzeLoadingSpinner = document.getElementById('analyzeLoadingSpinner');

            analyzeButton.disabled = true;
            analyzeButtonText.textContent = 'جاري التحليل...';
            analyzeLoadingSpinner.classList.remove('hidden');

            // Collect user profile data for context
            const skinType = document.getElementById('skinType').value;
            const skinConcerns = Array.from(document.querySelectorAll('.skin-concern-checkbox:checked')).map(cb => cb.value);
            const userAge = document.getElementById('userAge').value;
            const isPregnant = document.getElementById('isPregnant').checked;
            const medicalConditions = document.getElementById('medicalConditionsInput').value;
            const hairType = document.getElementById('hairType').value;
            const hairConcerns = Array.from(document.querySelectorAll('.hair-concern-checkbox:checked')).map(cb => cb.value);
            const preferredIngredients = Array.from(document.querySelectorAll('#preferredIngredientsList .tag span:first-child')).map(span => span.textContent);
            const excludedIngredients = Array.from(document.querySelectorAll('#excludedIngredientsList .tag span:first-child')).map(span => span.textContent);

            const prompt = `
                حلل قائمة المكونات التالية لمنتج عناية بالبشرة أو الشعر. قدم ملخصًا للمكونات، ثم قائمة تفصيلية بكل مكون وفوائده/عيوبه بناءً على ملف المستخدم المقدم، وتوصيات مخصصة.
                المكونات: ${ingredientsInput}
                
                ملف المستخدم:
                نوع البشرة: ${skinType}
                اهتمامات البشرة: ${skinConcerns.join(', ') || 'لا يوجد'}
                العمر: ${userAge || 'غير محدد'}
                هل حامل: ${isPregnant ? 'نعم' : 'لا'}
                حالات طبية: ${medicalConditions || 'لا يوجد'}
                نوع الشعر: ${hairType}
                اهتمامات الشعر: ${hairConcerns.join(', ') || 'لا يوجد'}
                المكونات المفضلة: ${preferredIngredients.join(', ') || 'لا يوجد'}
                المكونات المستبعدة: ${excludedIngredients.join(', ') || 'لا يوجد'}

                التنسيق المطلوب للرد (يجب أن يكون JSON):
                {
                    "summary": "ملخص عام للمكونات.",
                    "breakdown": [
                        {"ingredient": "اسم المكون", "analysis": "فوائده/عيوبه بناءً على ملف المستخدم"},
                        ...
                    ],
                    "preferredMatches": ["مكون مفضل 1", "مكون مفضل 2"],
                    "excludedMatches": ["مكون مستبعد 1", "مكون مستبعد 2"],
                    "recommendations": "توصيات شخصية بناءً على التحليل وملف المستخدم."
                }
            `;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { 
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "summary": { "type": "STRING" },
                                "breakdown": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "ingredient": { "type": "STRING" },
                                            "analysis": { "type": "STRING" }
                                        }
                                    }
                                },
                                "preferredMatches": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                },
                                "excludedMatches": {
                                    "type": "ARRAY",
                                    "items": { "type": "STRING" }
                                },
                                "recommendations": { "type": "STRING" }
                            },
                            "propertyOrdering": ["summary", "breakdown", "preferredMatches", "excludedMatches", "recommendations"]
                        }
                    }
                };
                // Use firebaseConfig.apiKey for Gemini API calls
                const apiKey = firebaseConfig.apiKey; 
                // Changed model to gemini-2.0-flash
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; 
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log("Gemini API Raw Response (Analyze):", result); // Log raw response

                if (response.ok) { // Check for successful HTTP status (2xx)
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const rawTextResponse = result.candidates[0].content.parts[0].text;
                        console.log("Gemini API Raw Text Response (Analyze):", rawTextResponse);
                        try {
                            const jsonResponse = JSON.parse(rawTextResponse);
                            displayAnalysisResults(jsonResponse);
                            showMessage("تم التحليل بنجاح!", 'success');
                        } catch (parseError) {
                            console.error("Error parsing JSON from Gemini API (Analyze):", parseError, "Raw text:", rawTextResponse);
                            showMessage("فشل التحليل: استجابة غير صالحة من النموذج (مشكلة في تنسيق JSON). يرجى التحقق من وحدة التحكم.", 'error');
                        }
                    } else {
                        showMessage("فشل التحليل: لم يتم استلام استجابة صالحة من النموذج. يرجى التحقق من وحدة التحكم.", 'error');
                        console.error("Invalid response structure:", result);
                    }
                } else { // Handle non-2xx HTTP responses
                    const errorDetail = result.error ? result.error.message : JSON.stringify(result);
                    showMessage(`خطأ في التحليل (${response.status}): ${errorDetail}. يرجى التحقق من الأذونات وحدود الاستخدام في Google Cloud Console.`, 'error');
                    console.error("API error response:", result);
                }
            } catch (e) {
                console.error("Error during ingredient analysis (fetch or network):", e);
                showMessage(`خطأ في التحليل: ${e.message}. يرجى التحقق من اتصال الإنترنت وتفعيل Gemini API.`, 'error');
            } finally {
                analyzeButton.disabled = false;
                analyzeButtonText.textContent = 'تحليل المكونات';
                analyzeLoadingSpinner.classList.add('hidden');
            }
        }

        function displayAnalysisResults(results) {
            document.getElementById('analysisResults').classList.remove('hidden');
            document.getElementById('summaryText').textContent = results.summary || 'لا يوجد ملخص.';

            const breakdownList = document.getElementById('breakdownList');
            breakdownList.innerHTML = '';
            if (results.breakdown && results.breakdown.length > 0) {
                results.breakdown.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong class="text-emerald-700">${item.ingredient}:</strong> ${item.analysis}`;
                    breakdownList.appendChild(li);
                });
            } else {
                breakdownList.innerHTML = '<li>لا يوجد تفصيل للمكونات.</li>';
            }

            const preferredMatchList = document.getElementById('preferredMatchList');
            preferredMatchList.innerHTML = '';
            if (results.preferredMatches && results.preferredMatches.length > 0) {
                results.preferredMatches.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    preferredMatchList.appendChild(li);
                });
            } else {
                preferredMatchList.innerHTML = '<li>لم يتم العثور على مكونات مفضلة مطابقة.</li>';
            }

            const excludedMatchList = document.getElementById('excludedMatchList');
            excludedMatchList.innerHTML = '';
            if (results.excludedMatches && results.excludedMatches.length > 0) {
                results.excludedMatches.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    excludedMatchList.appendChild(li);
                });
            } else {
                excludedMatchList.innerHTML = '<li>لم يتم العثور على مكونات مستبعدة مطابقة.</li>';
            }

            document.getElementById('recommendationsText').textContent = results.recommendations || 'لا توجد توصيات.';
        }

        // --- Image Scanning (OCR + LLM) ---
        async function scanImageForIngredients() {
            const imageInput = document.getElementById('imageUpload');
            const imageFile = imageInput.files[0];
            if (!imageFile) {
                showMessage("الرجاء تحديد صورة للمسح الضوئي.", 'warning');
                return;
            }

            const scanButton = document.getElementById('scanImageBtn');
            const scanButtonText = document.getElementById('scanButtonText');
            const scanLoadingSpinner = document.getElementById('scanLoadingSpinner');

            scanButton.disabled = true;
            scanButtonText.textContent = 'جاري المسح...';
            scanLoadingSpinner.classList.remove('hidden');

            try {
                // Read image as Base64
                const reader = new FileReader();
                reader.readAsDataURL(imageFile);
                reader.onloadend = async () => {
                    const base64ImageData = reader.result.split(',')[1]; // Get base64 string

                    const prompt = "استخرج جميع مكونات المنتج من هذه الصورة في قائمة منسقة. اكتبها كمكونات فردية.";
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                    const payload = {
                        contents: [
                            {
                                role: "user",
                                parts: [
                                    { text: prompt },
                                    {
                                        inlineData: {
                                            mimeType: imageFile.type,
                                            data: base64ImageData
                                        }
                                    }
                                ]
                            }
                        ],
                    };
                    // Use firebaseConfig.apiKey for Gemini API calls
                    const apiKey = firebaseConfig.apiKey; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; 
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    console.log("Gemini API Raw Response (Image Scan):", result); // Log raw response

                    if (response.ok) { // Check for successful HTTP status (2xx)
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const extractedText = result.candidates[0].content.parts[0].text;
                            document.getElementById('ingredientsInput').value = extractedText.trim();
                            showMessage("تم استخراج المكونات بنجاح من الصورة!", 'success');
                        } else {
                            showMessage("فشل استخراج المكونات من الصورة.", 'error');
                            console.error("Invalid response from image scan:", result);
                        }
                    } else {
                        const errorDetail = result.error ? result.error.message : JSON.stringify(result);
                        showMessage(`خطأ في مسح الصورة (${response.status}): ${errorDetail}. يرجى التحقق من الأذونات وحدود الاستخدام في Google Cloud Console.`, 'error');
                        console.error("API error response (Image Scan):", result);
                    }
                };
                reader.onerror = (error) => {
                    console.error("خطأ في قراءة ملف الصورة.", 'error');
                    showMessage("خطأ في قراءة ملف الصورة.", 'error');
                };

            } catch (e) {
                console.error("Error during image scanning (fetch or network):", e);
                showMessage(`خطأ في مسح الصورة: ${e.message}. يرجى التحقق من اتصال الإنترنت وتفعيل Gemini API.`, 'error');
            } finally {
                scanButton.disabled = false;
                scanButtonText.textContent = 'مسح وتحليل المكونات من الصورة';
                scanLoadingSpinner.classList.add('hidden');
            }
        }

        // --- Quick Ingredient Lookup ---
        async function quickIngredientLookup() {
            const ingredientName = document.getElementById('quickIngredientSearchInput').value.trim();
            if (!ingredientName) {
                showMessage("الرجاء إدخال اسم المكون للبحث السريع.", 'warning');
                return;
            }

            const searchResultDiv = document.getElementById('quickSearchResult');
            searchResultDiv.classList.remove('hidden', 'found', 'not-found');
            searchResultDiv.innerHTML = '<p class="text-gray-700">جاري البحث عن معلومات عن المكون...</p>';

            // Get current user profile for personalized lookup
            const skinType = document.getElementById('skinType').value;
            const skinConcerns = Array.from(document.querySelectorAll('.skin-concern-checkbox:checked')).map(cb => cb.value);
            const hairType = document.getElementById('hairType').value;
            const hairConcerns = Array.from(document.querySelectorAll('.hair-concern-checkbox:checked')).map(cb => cb.value);
            const isPregnant = document.getElementById('isPregnant').checked;

            const prompt = `
                قدم معلومات مفصلة عن المكون التالي: "${ingredientName}".
                وضح فوائده واستخداماته الشائعة في منتجات العناية بالبشرة والشعر.
                إذا كان المكون قد يكون ضارًا أو غير مناسبًا، اذكر ذلك بوضوح.
                إذا كانت هناك أي اعتبارات خاصة لهذا المكون بناءً على ملف المستخدم التالي، يرجى ذكرها:
                ملف المستخدم:
                نوع البشرة: ${skinType}
                اهتمامات البشرة: ${skinConcerns.join(', ') || 'لا يوجد'}
                نوع الشعر: ${hairType}
                اهتمامات الشعر: ${hairConcerns.join(', ') || 'لا يوجد'}
                هل حامل: ${isPregnant ? 'نعم' : 'لا'}
                
                التنسيق المطلوب للرد (يجب أن يكون JSON):
                {
                    "ingredientName": "اسم المكون",
                    "found": true/false,
                    "description": "وصف عام",
                    "benefits": ["فائدة 1", "فائدة 2"],
                    "considerations": ["اعتبار 1", "اعتبار 2"],
                    "suitability": "ملخص صلاحية المكون بناءً على ملف المستخدم."
                }
            `;

            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { 
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "ingredientName": { "type": "STRING" },
                                "found": { "type": "BOOLEAN" },
                                "description": { "type": "STRING" },
                                "benefits": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "considerations": { "type": "ARRAY", "items": { "type": "STRING" } },
                                "suitability": { "type": "STRING" }
                            },
                            "propertyOrdering": ["ingredientName", "found", "description", "benefits", "considerations", "suitability"]
                        }
                    }
                };
                // Use firebaseConfig.apiKey for Gemini API calls
                const apiKey = firebaseConfig.apiKey; 
                // Changed model to gemini-2.0-flash
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; 
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log("Gemini API Raw Response (Quick Lookup):", result); // Log raw response

                if (response.ok) { // Check for successful HTTP status (2xx)
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const rawTextResponse = result.candidates[0].content.parts[0].text;
                        console.log("Gemini API Raw Text Response (Quick Lookup):", rawTextResponse);
                        try {
                            const jsonResponse = JSON.parse(rawTextResponse);
                            displayQuickSearchResult(jsonResponse);
                        } catch (parseError) {
                            console.error("Error parsing JSON from Gemini API (Quick Lookup):", parseError, "Raw text:", rawTextResponse);
                            searchResultDiv.innerHTML = `<p class="text-red-700">فشل البحث: استجابة غير صالحة من النموذج (مشكلة في تنسيق JSON). يرجى التحقق من وحدة التحكم.</p>`;
                            searchResultDiv.classList.add('not-found');
                        }
                    } else {
                        searchResultDiv.innerHTML = `<p class="text-red-700">لم يتم العثور على معلومات مفصلة عن "${ingredientName}". يرجى التحقق من وحدة التحكم.</p>`;
                        searchResultDiv.classList.add('not-found');
                    }
                } else { // Handle non-2xx HTTP responses
                    const errorDetail = result.error ? result.error.message : JSON.stringify(result);
                    searchResultDiv.innerHTML = `<p class="text-red-700">حدث خطأ أثناء البحث (${response.status}): ${errorDetail}. يرجى التحقق من الأذونات وحدود الاستخدام في Google Cloud Console. هنا المشكلة في الأذونات.</p>`;
                    searchResultDiv.classList.add('not-found');
                    console.error("API error response:", result);
                }
            } catch (e) {
                console.error("Error during quick lookup (fetch or network):", e);
                searchResultDiv.innerHTML = `<p class="text-red-700">حدث خطأ أثناء البحث: ${e.message}. يرجى التحقق من اتصال الإنترنت وتفعيل Gemini API.</p>`;
                searchResultDiv.classList.add('not-found');
            }
        }

        function displayQuickSearchResult(result) {
            const searchResultDiv = document.getElementById('quickSearchResult');
            searchResultDiv.classList.remove('hidden', 'found', 'not-found');
            searchResultDiv.innerHTML = ''; // Clear previous results

            if (result.found) {
                searchResultDiv.classList.add('found');
                let benefitsHtml = result.benefits.length > 0 ? `<ul>${result.benefits.map(b => `<li>${b}</li>`).join('')}</ul>` : 'لا توجد فوائد مذكورة.';
                let considerationsHtml = result.considerations.length > 0 ? `<ul>${result.considerations.map(c => `<li>${c}</li>`).join('')}</ul>` : 'لا توجد اعتبارات خاصة.';

                searchResultDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-emerald-800">${result.ingredientName}</h3>
                    <p class="mb-2">${result.description}</p>
                    <p><strong>الفوائد:</strong></p>
                    ${benefitsHtml}
                    <p class="mt-2"><strong>اعتبارات خاصة:</strong></p>
                    ${considerationsHtml}
                    <p class="mt-2"><strong>الصلاحية لملفك الشخصي:</strong> ${result.suitability}</p>
                `;
            } else {
                searchResultDiv.classList.add('not-found');
                searchResultDiv.innerHTML = `<p class="text-red-700">لم يتم العثور على معلومات مفصلة عن "${result.ingredientName}".</p>`;
            }
        }

        // --- New: Suggest New Ingredient Function ---
        async function submitNewIngredientSuggestion() {
            const newIngredientInput = document.getElementById('newIngredientSuggestionInput');
            const ingredientName = newIngredientInput.value.trim();

            if (!ingredientName) {
                showMessage("الرجاء إدخال اسم المكون المقترح.", 'warning');
                return;
            }
            if (!db || !userId || userId === 'anonymous') {
                showMessage("يرجى تسجيل الدخول لاقتراح مكونات جديدة.", 'error');
                return;
            }

            const suggestButton = document.getElementById('submitNewIngredientSuggestionBtn');
            const suggestButtonText = document.getElementById('suggestButtonText');
            const suggestLoadingSpinner = document.getElementById('suggestLoadingSpinner');

            suggestButton.disabled = true;
            suggestButtonText.textContent = 'جاري الإرسال...';
            suggestLoadingSpinner.classList.remove('hidden');

            try {
                // Use addDoc for a new document with auto-generated ID
                await addDoc(ingredientSuggestionsCollectionRef, {
                    ingredient: ingredientName,
                    suggestedBy: userId,
                    timestamp: serverTimestamp(), // Use serverTimestamp for consistent timestamps
                    status: 'pending' // Initial status
                });
                showMessage(`تم إرسال اقتراحك للمكون "${ingredientName}" بنجاح! شكراً لك.`, 'success');
                newIngredientInput.value = ''; // Clear input
            } catch (e) {
                console.error("Error submitting ingredient suggestion:", e);
                showMessage(`خطأ في إرسال الاقتراح: ${e.message}`, 'error');
                // **************************************************************************************************
                // *** حل مشكلة أذونات Firestore (للبيانات العامة):                                              ***
                // *** إذا كنت تواجه خطأ "Missing or insufficient permissions" هنا، فهذا يعني أن قواعد أمان    ***
                // *** Firestore الخاصة بك تحتاج إلى تحديث.                                                        ***
                // *** لتمكين الكتابة لمجموعة 'public/data' (مثل 'ingredientSuggestions')،                       ***
                // *** تأكد من تعيين القواعد التالية في Firebase Console -> Firestore Database -> Rules:          ***
                // *** ***
                // *** match /artifacts/{appId}/public/data/{document=**} { allow read, write: if request.auth != null; } ***
                // *** ***
                // **************************************************************************************************
            } finally {
                suggestButton.disabled = false;
                suggestButtonText.textContent = 'إرسال الاقتراح';
                suggestLoadingSpinner.classList.add('hidden');
            }
        }


        // --- Autocomplete for Ingredients (Preferred, Excluded, Main Input) ---
        // Placeholder for a comprehensive ingredient database
        const allIngredients = [
            // Base Ingredients
            "Water", "Glycerin", "Aqua", "ماء", "جليسرين",

            // Hydrators & Humectants
            "Hyaluronic Acid", "Sodium Hyaluronate", "Sodium PCA", "Urea", "Panthenol", "Butylene Glycol", "Propylene Glycol", "Caprylic/Capric Triglyceride",
            "حمض الهيالورونيك", "هيالورونات الصوديوم", "صوديوم PCA", "يوريا", "بانثينول", "بوتيلين جلايكول", "بروبيلين جلايكول", "كابريليك/كابريك ثلاثي الجليسريد",

            // Actives - Vitamins & Antioxidants
            "Niacinamide", "Vitamin C", "Ascorbic Acid", "Sodium Ascorbyl Phosphate", "Magnesium Ascorbyl Phosphate", "Tetrahexyldecyl Ascorbate",
            "Vitamin E", "Tocopherol", "Vitamin A", "Retinol", "Retinaldehyde", "Tretinoin", "Retinyl Palmitate",
            "Coenzyme Q10", "Ubiquinone", "Ferulic Acid", "Alpha Lipoic Acid", "Glutathione",
            "نياسيناميد", "فيتامين سي", "حمض الأسكوربيك", "أسكوربيل فوسفات الصوديوم", "أسكوربيل فوسفات المغنيسيوم", "تيتراهيكسيل ديسيل أسكوربات",
            "فيتامين هـ", "توكوفيرول", "فيتامين أ", "ريتينول", "ريتينالديهايد", "تريتينوين", "ريتينيل بالميتات",
            "أنزيم Q10", "يوبيكوينون", "حمض الفيروليك", "حمض ألفا ليبويك", "جلوتاثيون",

            // Actives - Acids (AHAs, BHAs, PHAs, others)
            "Glycolic Acid", "Lactic Acid", "Mandelic Acid", "Citric Acid", "Malic Acid", "Tartaric Acid", "AHA",
            "Salicylic Acid", "BHA",
            "Gluconolactone", "Lactobionic Acid", "PHA",
            "Azelaic Acid", "Tranexamic Acid", "Kojic Acid",
            "حمض الجليكوليك", "حمض اللاكتيك", "حمض الماندليك", "حمض الستريك", "حمض الماليك", "حمض الطرطريك", "أحماض ألفا هيدروكسي",
            "حمض الساليسيليك", "أحماض بيتا هيدروكسي",
            "جلوكونولاكتون", "حمض اللاكتوبيونيك", "أحماض بولي هيدروكسي",
            "حمض الأزيليك", "حمض الترانيكساميك", "حمض الكوجيك",

            // Soothing & Calming Ingredients
            "Aloe Vera", "Allantoin", "Bisabolol", "Centella Asiatica Extract", "Madecassoside", "Asiaticoside",
            "Green Tea Extract", "Chamomile Extract", "Calendula Extract", "Oat Extract", "Licorice Root Extract",
            "ألوفيرا", "آلانتوين", "بيسابولول", "مستخلص سنتيلا أسياتيكا", "ماديكاسوسايد", "أسياتيكوسايد",
            "مستخلص الشاي الأخضر", "مستخلص البابونج", "مستخلص الآذريون", "مستخلص الشوفان", "مستخلص جذر عرق السوس",

            // Oils & Emollients
            "Shea Butter", "Cocoa Butter", "Jojoba Oil", "Argan Oil", "Coconut Oil", "Olive Oil", "Sunflower Seed Oil",
            "Squalane", "Mineral Oil", "Petrolatum", "Dimethicone", "Cyclopentasiloxane", "Silicones",
            "زبدة الشيا", "زبدة الكاكاو", "زيت الجوجوبا", "زيت الأرغان", "زيت جوز الهند", "زيت الزيتون", "زيت بذور عباد الشمس",
            "سكوالين", "زيت معدني", "فازلين", "دايميثيكون", "سيكلوبنتاسيلوكسان", "سيليكونات",

            // Peptides & Proteins
            "Peptides", "Collagen", "Elastin", "Keratin", "Hydrolyzed Wheat Protein", "Hydrolyzed Soy Protein",
            "ببتيدات", "كولاجين", "إيلاستين", "كيراتين", "بروتين القمح المتحلل", "بروتين الصويا المتحلل",

            // Hair Specific Ingredients
            "Biotin", "Caffeine", "Zinc Pyrithione", "Selenium Sulfide", "Ketoconazole", "Salicylic Acid (Hair)",
            "Rosemary Oil", "Peppermint Oil", "Castor Oil", "Coconut Oil (Hair)", "Argan Oil (Hair)",
            "بيوتين", "كافيين", "بيريثيون الزنك", "سيلينيد السيلينيوم", "كيتوكونازول", "حمض الساليسيليك (للشعر)",
            "زيت إكليل الجبل", "زيت النعناع", "زيت الخروع", "زيت جوز الهند (للشعر)", "زيت الأرغان (للشعر)",

            // Sunscreens
            "Titanium Dioxide", "Zinc Oxide", "Avobenzone", "Oxybenzone", "Octinoxate", "Octisalate", "Homosalate",
            "ثاني أكسيد التيتانيوم", "أكسيد الزنك", "أفوبنزون", "أوكسي بنزون", "أوكتينوكسات", "أوكتيسالات", "هوموسالات",

            // Excluded/Problematic (examples, based on common concerns)
            "Parfum", "Fragrance", "Alcohol Denat.", "Isopropyl Alcohol", "Sulfates", "Sodium Lauryl Sulfate", "Sodium Laureth Sulfate",
            "Parabens", "Methylparaben", "Propylparaben", "Formaldehyde Releasers", "DMDM Hydantoin", "Imidazolidinyl Urea",
            "Synthetic Dyes", "Phthalates", "Essential Oils", "Synthetic Fragrance", "BHT", "BHA (Preservative)",
            "عطر", "عطور", "كحول دينات", "كحول أيزوبروبيل", "كبريتات", "كبريتات لوريل الصوديوم", "كبريتات لوريث الصوديوم",
            "بارابين", "ميثيل بارابين", "بروبيل بارابين", "مطلقات الفورمالديهايد", "دي إم دي إم هيدانتوين", "يوريا إيميدازوليدينيل",
            "أصباغ صناعية", "فثالات", "زيوت أساسية", "عطر صناعي", "BHT", "BHA (مادة حافظة)",

            // Other widely known ingredients
            "Ceramides", "Snail Secretion Filtrate", "Saccharide Isomerate", "Probiotics", "Prebiotics",
            "Adenosine", "Alpha Arbutin", "Glycyrrhiza Glabra Root Extract", "Tranexamic Acid", "Bakuchiol",
            "ألفا أربوتين", "أدينوسين", "مرشح إفراز الحلزون", "سكاريد أيزوميرات", "بروبيوتيك", "بريبايوتيك",
            "مستخلص جذر عرق السوس", "حمض الترانيكساميك", "باكوشيول"
        ].sort(); // Sort alphabetically for consistent suggestions


        let currentActiveSuggestion = -1; // For keyboard navigation

        function setupAutocomplete(inputId, suggestionsId, addFunction) {
            const inputElement = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(suggestionsId);

            inputElement.addEventListener('input', () => {
                const query = inputElement.value.toLowerCase();
                suggestionsContainer.innerHTML = ''; // Clear previous suggestions
                currentActiveSuggestion = -1;

                if (query.length < 2) { // Start suggesting after 2 characters
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                const filteredSuggestions = allIngredients.filter(ingredient =>
                    ingredient.toLowerCase().includes(query)
                ).slice(0, 5); // Limit to 5 suggestions

                if (filteredSuggestions.length > 0) {
                    suggestionsContainer.classList.remove('hidden');
                    filteredSuggestions.forEach((suggestion, index) => {
                        const item = document.createElement('div');
                        item.classList.add('autocomplete-suggestion-item');
                        item.textContent = suggestion;
                        item.addEventListener('click', () => {
                            inputElement.value = suggestion;
                            addFunction(); // Trigger add function
                            suggestionsContainer.classList.add('hidden');
                        });
                        suggestionsContainer.appendChild(item);
                    });
                } else {
                    // New: Display "No results" message if no suggestions found
                    const noResultsItem = document.createElement('div');
                    noResultsItem.classList.add('autocomplete-suggestion-item', 'text-gray-500', 'italic');
                    noResultsItem.textContent = 'لا توجد نتائج مطابقة.';
                    suggestionsContainer.appendChild(noResultsItem);
                    suggestionsContainer.classList.remove('hidden'); // Keep visible to show "No results"
                }
            });

            inputElement.addEventListener('keydown', (e) => {
                const items = Array.from(suggestionsContainer.children);
                // Filter out the "No results" message if it exists
                const actualSuggestions = items.filter(item => !item.classList.contains('italic'));

                if (actualSuggestions.length === 0 && e.key !== 'Enter') return; // Only allow Enter if no suggestions

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentActiveSuggestion = (currentActiveSuggestion + 1) % actualSuggestions.length;
                    highlightSuggestion(actualSuggestions, inputElement);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentActiveSuggestion = (currentActiveSuggestion - 1 + actualSuggestions.length) % actualSuggestions.length;
                    highlightSuggestion(actualSuggestions, inputElement);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentActiveSuggestion > -1 && actualSuggestions[currentActiveSuggestion]) {
                        actualSuggestions[currentActiveSuggestion].click();
                    } else {
                        // If no suggestion selected or no actual suggestions, trigger add with current input
                        addFunction();
                    }
                    suggestionsContainer.classList.add('hidden');
                } else if (e.key === 'Escape') {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!inputElement.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            function highlightSuggestion(items, input) {
                items.forEach((item, index) => {
                    if (index === currentActiveSuggestion) {
                        item.classList.add('active');
                        input.value = item.textContent; // Update input with highlighted suggestion
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        }

        // --- Tag Management ---
        function addTag(listId, ingredientName, type = 'preferred') {
            const listElement = document.getElementById(listId);
            const tag = document.createElement('span');
            tag.classList.add('tag', 'transition-all', 'duration-200');
            if (type === 'excluded') {
                tag.classList.add('tag-excluded');
            }
            tag.innerHTML = `<span>${ingredientName}</span><span class="tag-remove">&times;</span>`;
            
            tag.querySelector('.tag-remove').addEventListener('click', () => {
                tag.remove();
            });
            listElement.appendChild(tag);
        }

        // --- BMI / Weight Calculations ---
        function calculateIdealWeight() {
            const heightCm = parseFloat(document.getElementById('userHeightCm').value);
            const idealWeightDisplay = document.getElementById('idealWeightDisplay');

            if (heightCm > 0) {
                // Using Devine formula for ideal weight (approximation for adults)
                // For men: 50 kg + 2.3 kg for each inch over 5 feet
                // For women: 45.5 kg + 2.3 kg for each inch over 5 feet
                // Assuming a generic average for simplicity, or could prompt for gender
                // Let's use a simpler BMI-based approximation for a healthy range
                // Healthy BMI is 18.5 to 24.9
                // Weight (kg) = BMI * (Height in meters)^2
                const heightM = heightCm / 100;
                const minIdealWeight = 18.5 * (heightM * heightM);
                const maxIdealWeight = 24.9 * (heightM * heightM);
                idealWeightDisplay.textContent = `${minIdealWeight.toFixed(1)} - ${maxIdealWeight.toFixed(1)} كجم`;
            } else {
                idealWeightDisplay.textContent = 'أدخل طولك للحساب';
            }
            calculateWeightToIdeal(); // Recalculate when height changes
        }

        function calculateWeightToIdeal() {
            const heightCm = parseFloat(document.getElementById('userHeightCm').value);
            const currentWeightKg = parseFloat(document.getElementById('currentWeightKg').value);
            const weightToIdealDisplay = document.getElementById('weightToIdealDisplay');

            if (heightCm > 0 && currentWeightKg > 0) {
                const heightM = heightCm / 100;
                const bmi = currentWeightKg / (heightM * heightM);
                const idealBMI = 22; // Mid-point of healthy BMI range
                const targetIdealWeight = idealBMI * (heightM * heightM);
                const difference = currentWeightKg - targetIdealWeight;

                if (Math.abs(difference) < 0.5) { // Within a small tolerance
                    weightToIdealDisplay.textContent = 'أنت قريب جداً من الوزن المثالي!';
                    weightToIdealDisplay.classList.remove('text-red-700', 'text-green-700');
                    weightToIdealDisplay.classList.add('text-blue-700');
                } else if (difference > 0) {
                    weightToIdealDisplay.textContent = `${difference.toFixed(1)} كجم فوق الوزن المثالي`;
                    weightToIdealDisplay.classList.remove('text-green-700', 'text-blue-700');
                    weightToIdealDisplay.classList.add('text-red-700');
                } else {
                    weightToIdealDisplay.textContent = `${Math.abs(difference).toFixed(1)} كجم متبقية للوزن المثالي`;
                    weightToIdealDisplay.classList.remove('text-red-700', 'text-blue-700');
                    weightToIdealDisplay.classList.add('text-green-700');
                }
            } else {
                weightToIdealDisplay.textContent = 'أدخل طولك ووزنك للحساب';
                weightToIdealDisplay.classList.remove('text-red-700', 'text-green-700', 'text-blue-700');
            }
        }

        /**
         * Function to load AdSense ads.
         * This should be called after the DOM is fully loaded and elements have their sizes.
         */
        function loadAdSenseAds() {
            if (typeof window.adsbygoogle !== 'undefined') {
                setTimeout(() => { // Add a small delay to ensure layout is settled
                    document.querySelectorAll('ins.adsbygoogle').forEach(ins => {
                        // Check if the ad has already been loaded for this slot
                        if (ins.getAttribute('data-ad-loaded') === 'true') {
                            console.log('AdSense already loaded for slot:', ins.getAttribute('data-ad-slot'));
                            return; // Skip if already loaded
                        }
                        
                        // Check if the element has a non-zero width
                        if (ins.offsetWidth > 0) {
                            try {
                                (window.adsbygoogle = window.adsbygoogle || []).push({});
                                ins.setAttribute('data-ad-loaded', 'true'); // Mark as loaded
                                console.log('AdSense pushed for slot:', ins.getAttribute('data-ad-slot'));
                            } catch (e) {
                                console.error('Error pushing AdSense ad:', e);
                            }
                        } else {
                            console.warn('AdSense slot has zero width, skipping:', ins.getAttribute('data-ad-slot'), 'offsetWidth:', ins.offsetWidth);
                            // Optionally, you could retry pushing these later with another setTimeout or an Intersection Observer
                        }
                    });
                }, 1000); // Increased delay to 1000ms for better layout stability
            } else {
                console.warn('adsbygoogle script not loaded yet or blocked.');
            }
        }

        // --- Collapsible Sections Logic ---
        function setupCollapsibleSections() {
            const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
            collapsibleHeaders.forEach(header => {
                const targetId = header.dataset.target;
                const content = document.getElementById(targetId);
                const arrowIcon = header.querySelector('.icon-arrow');

                // Initially close all sections except the first one (Dashboard)
                if (targetId !== 'dashboardContent') { // Assuming Dashboard is the first and should be open by default
                    content.classList.remove('open');
                    header.classList.remove('active');
                } else {
                    content.classList.add('open');
                    header.classList.add('active');
                }
                
                header.addEventListener('click', () => {
                    const isOpen = content.classList.contains('open');

                    // Close all other open sections
                    collapsibleHeaders.forEach(otherHeader => {
                        const otherContent = document.getElementById(otherHeader.dataset.target);
                        if (otherContent !== content && otherContent.classList.contains('open')) {
                            otherContent.classList.remove('open');
                            otherHeader.classList.remove('active');
                        }
                    });

                    // Toggle current section
                    if (isOpen) {
                        content.classList.remove('open');
                        header.classList.remove('active');
                    } else {
                        content.classList.add('open');
                        header.classList.add('active');
                    }
                });
            });
        }


        // --- Event Listeners ---
        window.onload = async () => {
            // Initialize Firebase first
            initFirebase();
            
            // Then, authenticate the user. This relies on 'auth' being initialized by initFirebase.
            await authenticateUser(); // This will sign in anonymously or with custom token

            // Setup collapsible sections AFTER Firebase init to ensure elements are ready
            setupCollapsibleSections();


            // Set up event listeners for profile management
            document.getElementById('saveProfileBtn').addEventListener('click', () => {
                const profileName = document.getElementById('profileNameInput').value;
                if (profileName) {
                    saveUserProfile(profileName);
                } else {
                    showMessage("الرجاء إدخال اسم لملفك الشخصي للحفظ.", 'warning');
                }
            });

            document.getElementById('loadNamedProfileBtn').addEventListener('click', () => {
                const selectedProfile = document.getElementById('existingProfilesSelect').value;
                if (selectedProfile) {
                    loadUserProfile(selectedProfile);
                } else {
                    showMessage("الرجاء اختيار ملف شخصي للتحميل.", 'warning');
                }
            });

            document.getElementById('deleteProfileBtn').addEventListener('click', () => {
                const selectedProfile = document.getElementById('existingProfilesSelect').value;
                if (selectedProfile) {
                    deleteUserProfile(selectedProfile);
                } else {
                    showMessage("الرجاء اختيار ملف شخصي للحذف.", 'warning');
                }
            });

            document.getElementById('existingProfilesSelect').addEventListener('change', (e) => {
                const selectedProfile = e.target.value;
                document.getElementById('profileNameInput').value = selectedProfile; // Update input with selected profile name
            });


            // Set up event listeners for admin settings
            document.getElementById('updateGlobalSettingsBtn').addEventListener('click', updateGlobalSettings);

            // Set up event listeners for core features
            document.getElementById('analyzeIngredientsBtn').addEventListener('click', analyzeIngredients);
            document.getElementById('scanImageBtn').addEventListener('click', scanImageForIngredients);
            document.getElementById('quickSearchBtn').addEventListener('click', quickIngredientLookup);
            document.getElementById('submitNewIngredientSuggestionBtn').addEventListener('click', submitNewIngredientSuggestion); // New listener for suggestion button

            // Image upload preview
            document.getElementById('imageUpload').addEventListener('change', (event) => {
                const [file] = event.target.files;
                if (file) {
                    const preview = document.getElementById('imagePreview');
                    const container = document.getElementById('imagePreviewContainer');
                    preview.src = URL.createObjectURL(file);
                    container.classList.remove('hidden');
                } else {
                    document.getElementById('imagePreviewContainer').classList.add('hidden');
                }
            });

            // Autocomplete setup
            setupAutocomplete('preferredIngredientInput', 'preferredSuggestions', () => {
                const input = document.getElementById('preferredIngredientInput');
                if (input.value.trim()) {
                    addTag('preferredIngredientsList', input.value.trim());
                    input.value = '';
                }
            });
            setupAutocomplete('excludedIngredientInput', 'excludedSuggestions', () => {
                const input = document.getElementById('excludedIngredientInput');
                if (input.value.trim()) {
                    addTag('excludedIngredientsList', input.value.trim(), 'excluded');
                    input.value = '';
                }
            });
            setupAutocomplete('quickIngredientSearchInput', 'quickSearchSuggestions', quickIngredientLookup);
            setupAutocomplete('ingredientsInput', 'mainIngredientSuggestions', () => { /* no direct add needed for main input */ });


            // BMI/Weight calculations on input change
            document.getElementById('userHeightCm').addEventListener('input', calculateIdealWeight);
            document.getElementById('currentWeightKg').addEventListener('input', calculateWeightToIdeal);

            // Help button functionality
            document.getElementById('showHelpBtn').addEventListener('click', () => {
                showMessage(`
                    مرحباً بك في أداة مقارنة المكونات الذكي!
                    1. لوحة التحكم: تعرض عدد المستخدمين النشطين وتسمح للمسؤولين بإضافة إعلانات عامة.
                    2. إدارة الملفات الشخصية: احفظ، حمل، واحذف ملفاتك الشخصية.
                    3. مسح المكونات من صورة: حمل صورة لملصق المكونات وسنقوم باستخراجها لك.
                    4. البحث السريع عن مكون: ابحث عن معلومات فورية عن مكون واحد.
                    5. اقتراح مكونات جديدة: إذا لم تجد مكوناً، اقترحه لنا.
                    6. ملفك الشخصي للبشرة والشعر: أدخل معلوماتك لتخصيص التحليل.
                    7. المكونات المفضلة/المستبعدة: أضف المكونات التي تفضلها أو تتحسس منها.
                    8. تحليل المكونات: الصق قائمة المكونات لتحليلها بناءً على ملفك الشخصي.
                `, 'info');
            });

            // Add event listener for the new sign in/out button
            document.getElementById('signInSignOutBtn').addEventListener('click', handleSignInSignOut);


            // Load AdSense ads after all other DOM content and layout have settled
            loadAdSenseAds();
        };
    </script>
</body>
</html>
